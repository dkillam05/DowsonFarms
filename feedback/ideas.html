<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#365E5A" />
  <title>Ideas ‚Äî Farm Vista</title>

  <!-- Prepaint theme (no flash) -->
  <script>
    (function () {
      const pref = localStorage.getItem('df_theme') || 'auto';
      const dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const mode = pref === 'auto' ? (dark ? 'dark' : 'light') : pref;
      document.documentElement.setAttribute('data-theme', mode);
      document.documentElement.style.colorScheme = mode === 'dark' ? 'dark' : 'light';
    })();
  </script>

  <!-- App theme + version + core (golden tree paths) -->
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script defer src="../js/version.js"></script>
  <script defer src="../js/core.js"></script>

  <!-- Menus data (golden tree: assets/data/menus.js) -->
  <script defer src="../assets/data/menus.js"></script>

  <link rel="manifest" href="../manifest.webmanifest" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="../assets/icons/apple-touch-icon.png" />
  <link rel="icon" sizes="192x192" href="../assets/icons/icon-192.png" />
  <link rel="icon" sizes="512x512" href="../assets/icons/icon-512.png" />

  <style>
    /* Page-local tweaks only (keeps theme.css clean) */
    .shots-grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(96px,1fr)); gap:10px; margin-top:8px;
    }
    .shot{ position:relative; border:1px solid var(--tile-border); border-radius:10px; overflow:hidden; background:var(--tile-bg); }
    .shot img{ display:block; width:100%; height:100%; object-fit:cover; aspect-ratio:1/1; }
    .shot button{ position:absolute; top:6px; right:6px; border:none; border-radius:8px; padding:4px 6px; font-size:.8rem; background:rgba(20,50,49,0.7); color:#fff; cursor:pointer; }
    .drop-zone{ border:1px dashed var(--tile-border); border-radius:10px; padding:12px; text-align:center; background:transparent; }
    .drop-zone.drag{ background:var(--tile-bg, rgba(54,94,90,0.06)); }

    /* One-line banner toast (3s) */
    #dfToast {
      display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 14px; border-radius:10px; border:1px solid var(--tile-border);
      background:var(--tile-bg); box-shadow:0 6px 24px rgba(23,52,49,0.18); z-index:9999;
      max-width:90vw; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    #btnGrid{
      --w: 92px;
      display:grid; gap:10px;
      grid-template-columns: var(--w) var(--w);
      justify-content:center;
    }
    .inline-note{ font-size:.9rem; color:#4B5A58; }
  </style>
</head>
<body>
  <!-- Header (core.js handles logout, clock, etc.) -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="../assets/icons/Farm_Vista_Logo.png" alt="Farm Vista Logo" class="app-logo" />
      <div class="app-header__title">Farm Vista</div>
    </div>
    <div class="app-header__right"><span id="clock" class="clock">--:--</span></div>
  </header>

  <!-- Breadcrumbs (core.js renders the UI) -->
  <nav class="breadcrumbs" aria-label="Breadcrumb"></nav>

  <!-- Content -->
  <main class="content" data-has-form>
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1 style="margin:0;">üí° Ideas</h1>
    </div>
    <p class="muted" style="margin-top:8px;">Share an idea for improving the app. Attach an optional screenshot.</p>

    <form id="ideaForm" novalidate>
      <!-- Submitted by (employees) -->
      <div class="field">
        <label for="submittedBy">Submitted by</label>
        <select id="submittedBy" required></select>
        <small id="whoHint" class="inline-note"></small>
      </div>

      <!-- Date -->
      <div class="field">
        <label for="submittedDate">Date</label>
        <input id="submittedDate" type="date" required />
      </div>

      <!-- Menu + Submenu (dynamic from menus.js) -->
      <div class="field">
        <label for="menuSel">Menu</label>
        <select id="menuSel" required></select>
        <div id="menuOtherWrap" class="row" style="gap:8px; margin-top:6px; display:none;">
          <input id="menuOther" type="text" placeholder="Type a new menu‚Ä¶" />
        </div>
      </div>

      <div class="field">
        <label for="submenuSel">Submenu</label>
        <select id="submenuSel" required></select>
        <div id="submenuOtherWrap" class="row" style="gap:8px; margin-top:6px; display:none;">
          <input id="submenuOther" type="text" placeholder="Type a new submenu‚Ä¶" />
        </div>
      </div>

      <!-- Message -->
      <div class="field">
        <label for="message">Idea</label>
        <textarea id="message" required placeholder="Describe your idea‚Ä¶"></textarea>
      </div>

      <!-- Screenshots -->
      <section class="card" style="padding:12px; margin-top:8px;">
        <div class="row" style="justify-content:space-between; align-items:center;">
          <h3 style="margin:0;">Screenshots (optional)</h3>
          <label class="btn-outline" for="shotsInput" style="cursor:pointer;">Add images</label>
          <input id="shotsInput" type="file" accept="image/*" multiple style="display:none" />
        </div>
        <div id="dropZone" class="drop-zone" style="margin-top:10px;">Drop images here or use ‚ÄúAdd images‚Äù</div>
        <div id="shotsGrid" class="shots-grid"></div>
        <small class="muted">Large images are compressed before upload. Up to ~6 per idea.</small>
      </section>

      <!-- Actions -->
      <section class="card" style="padding:12px; margin-top:8px;">
        <div id="btnGrid">
          <button class="btn-primary" type="submit" id="saveBtn" style="width:var(--w); height:var(--w); font-size:1.02rem;">Save</button>
          <button class="btn-outline" type="reset" id="clearBtn" style="width:var(--w); height:var(--w); font-size:1.02rem;">Clear</button>
          <button class="btn-outline" type="button" id="cancelBtn" style="width:var(--w); height:var(--w); font-size:1.02rem;">Cancel</button>
        </div>
      </section>
    </form>
  </main>

  <!-- Footer (core.js injects version + date) -->
  <footer class="app-footer">
    <span>Farm Vista</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Toast -->
  <div id="dfToast"><span id="dfToastText">Saved</span></div>

  <script>
  (function IdeasPage(){
    // ---------- Simple DOM helpers ----------
    const $ = (s) => document.querySelector(s);
    const $by = $('#submittedBy');
    const $date = $('#submittedDate');
    const $menu = $('#menuSel');
    const $menuOther = $('#menuOther');
    const $menuOtherWrap = $('#menuOtherWrap');
    const $sub = $('#submenuSel');
    const $submenuOther = $('#submenuOther');
    const $submenuOtherWrap = $('#submenuOtherWrap');
    const $msg = $('#message');
    const $shotsInput = $('#shotsInput');
    const $shotsGrid = $('#shotsGrid');
    const $dropZone = $('#dropZone');
    const $cancel = $('#cancelBtn');

    const ADD_OTHER = '__OTHER__';
    const MAX_IMAGES = 6;
    const MAX_LONG_EDGE = 1400;
    const JPEG_QUALITY = 0.8;

    // ---------- Breadcrumbs ----------
    window.setBreadcrumbs && window.setBreadcrumbs([
      {label:'Home', href:'../index.html'},
      {label:'Feedback', href:'./index.html'},
      {label:'Ideas'}
    ]);

    // ---------- Date default (Central Time) ----------
    function todayCT(){
      const now = new Date();
      const parts = new Intl.DateTimeFormat('en-CA',{timeZone:'America/Chicago',year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(now);
      const y=parts.find(p=>p.type==='year').value, m=parts.find(p=>p.type==='month').value, d=parts.find(p=>p.type==='day').value;
      return `${y}-${m}-${d}`;
    }
    $date.value = todayCT();

    // ---------- Toast (3s banner) ----------
    let toastTimer = null;
    function toast(t='Saved'){
      const box = document.getElementById('dfToast');
      const txt = document.getElementById('dfToastText');
      txt.textContent = t;
      box.style.display = 'block';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ box.style.display='none'; }, 3000);
    }

    // ---------- Employees (Firestore via window.DF if available; graceful fallback) ----------
    async function loadEmployees(){
      try{
        // Expect window.DF.db + DF.firestore (modular) OR compat firebase
        const DF = window.DF || {};
        const db = DF.db || null;

        let people = [];
        if (db && DF.firestore){
          const { collection, getDocs, query, orderBy } = DF.firestore;
          const snap = await getDocs(query(collection(db, 'employees'), orderBy('name')));
          snap.forEach(doc => {
            const d = doc.data() || {};
            if (d && d.name) people.push({name: d.name, id: doc.id});
          });
        } else if (window.firebase && window.firebase.firestore) {
          const snap = await window.firebase.firestore().collection('employees').orderBy('name').get();
          snap.forEach(doc => {
            const d = doc.data() || {};
            if (d && d.name) people.push({name: d.name, id: doc.id});
          });
        }

        if (people.length === 0) throw new Error('Empty employees list');

        $by.innerHTML = people.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        // Auto-select current user if available
        const youName = (window.getCurrentUser && window.getCurrentUser()) || localStorage.getItem('df_current_user') || '';
        if (youName){
          const opt = [...$by.options].find(o => o.textContent === youName);
          if (opt) $by.value = opt.value;
        }
        document.getElementById('whoHint').textContent = '';
      } catch(e){
        // Fallback to a basic list if Firestore unavailable (submit still works to local storage)
        const fallback = ['John Doe','Jane Smith','Sam Operator','Vendor Co.'];
        $by.innerHTML = fallback.map(n=>`<option>${n}</option>`).join('');
        document.getElementById('whoHint').textContent = 'Tip: Connect Firestore employees to populate this list.';
      }
    }

    // ---------- Menus (from assets/data/menus.js) ----------
    async function loadMenusData(){
      // Accept either global DF_MENUS, DF.getMenus(), or fallback
      let M = window.DF_MENUS;
      if (!M && window.DF && window.DF.getMenus) M = window.DF.getMenus();
      if (!M && window.__DF_MENUS_DEFAULT__) M = window.__DF_MENUS_DEFAULT__;
      if (!M){
        M = {
          "Home": ["‚Äî"],
          "Crop Production": ["Planting","Spraying","Harvest"],
          "Grain Tracking": ["Bins","Tickets","Contracts"],
          "Equipment": ["Maintenance","Repairs","Assignments"],
          "Calculators": ["Seed Rate","Fertilizer","ROI"],
          "Reports": ["Crops","Equipment","Financial"],
          "Teams / Partners": ["Employees","Vendors","Sub-Contractors"],
          "Feedback": ["Ideas","Bugs / Issues"],
          "Settings / Setup": ["Farms","Fields","Theme","Account Roles","Crop Types"]
        };
      }
      return M;
    }

    function renderMenuOptions(M){
      $menu.innerHTML = '';
      Object.keys(M).forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        $menu.appendChild(opt);
      });
      const other = document.createElement('option');
      other.value = ADD_OTHER; other.textContent = 'Other‚Ä¶';
      $menu.appendChild(other);
    }
    function renderSubmenuOptions(M, menuName){
      $sub.innerHTML = '';
      const subs = M[menuName] || [];
      subs.forEach(name=>{
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        $sub.appendChild(opt);
      });
      const other = document.createElement('option');
      other.value = ADD_OTHER; other.textContent = 'Other‚Ä¶';
      $sub.appendChild(other);
    }

    // ---------- Images: compress + UI ----------
    function dataUrlBytes(dataUrl){
      const b64 = (dataUrl.split(',')[1]||'');
      return Math.floor((b64.length*3)/4) - (b64.endsWith('==')?2:b64.endsWith('=')?1:0);
    }
    function fileToImage(file){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => { const img = new Image(); img.onload=()=>resolve(img); img.onerror=reject; img.src = fr.result; };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
    async function compressImage(file){
      try{
        const img = await fileToImage(file);
        const scale = Math.min(1, MAX_LONG_EDGE / Math.max(img.width, img.height));
        const w = Math.round(img.width * scale);
        const h = Math.round(img.height * scale);
        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);
        const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
        return { name: file.name || 'image.jpg', dataUrl, w, h, bytes: dataUrlBytes(dataUrl) };
      } catch(e){ console.error(e); return null; }
    }

    let attachments = []; // {name, dataUrl, w, h, bytes}
    function renderShots(){
      $shotsGrid.innerHTML = attachments.map((a, idx)=>`
        <div class="shot">
          <img src="${a.dataUrl}" alt="${a.name}" />
          <button type="button" data-idx="${idx}" aria-label="Remove">‚úï</button>
        </div>
      `).join('');
      $shotsGrid.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          attachments.splice(Number(btn.dataset.idx),1);
          renderShots();
        });
      });
    }
    async function addFiles(fileList){
      const files = Array.from(fileList||[]);
      if (!files.length) return;
      if (attachments.length + files.length > MAX_IMAGES){
        alert(`Please attach up to ${MAX_IMAGES} images per idea.`);
        return;
      }
      for (const f of files){
        const c = await compressImage(f);
        if (c) attachments.push(c);
      }
      renderShots();
    }
    $shotsInput.addEventListener('change', (e)=> addFiles(e.target.files));
    ;['dragenter','dragover'].forEach(ev=> $dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); $dropZone.classList.add('drag'); }));
    ;['dragleave','drop'].forEach(ev=> $dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); $dropZone.classList.remove('drag'); }));
    $dropZone.addEventListener('drop', (e)=> addFiles(e.dataTransfer.files));

    // ---------- Save (Firestore if available; otherwise local-only fallback) ----------
    function slug(s){
      return (s||'').trim().toLowerCase()
        .replace(/[\s_]+/g,'-')
        .replace(/[^a-z0-9\-]/g,'')
        .replace(/\-+/g,'-')
        .replace(/^\-+|\-+$/g,'');
    }

    async function saveIdea(){
      // Validate
      const byValRaw = $by.value;
      const byText = $by.options[$by.selectedIndex]?.textContent || '';
      const dateVal = $date.value;
      let menuVal = $menu.value;
      let submenuVal = $sub.value;
      if (menuVal === ADD_OTHER) menuVal = ($menuOther.value||'Other').trim();
      if (submenuVal === ADD_OTHER) submenuVal = ($submenuOther.value||'Other').trim();
      const msgVal = ($msg.value||'').trim();

      if (!byValRaw || !dateVal || !menuVal || !submenuVal || !msgVal){
        alert('Please complete all required fields.');
        return;
      }

      const now = Date.now();
      const permaKey = `${dateVal}-${slug(menuVal)}-${slug(submenuVal)}-${Math.random().toString(36).slice(2,8)}`;

      // Try Firestore (window.DF modular or compat). If unavailable, store locally so user isn‚Äôt blocked.
      let savedToCloud = false;
      try{
        const DF = window.DF || {};
        const db = DF.db || (window.firebase && window.firebase.firestore && window.firebase.firestore());
        const storage = DF.storage || (window.firebase && window.firebase.storage && window.firebase.storage());

        // Build record
        const docBody = {
          permaKey,
          submittedById: byValRaw,          // if employees loaded from Firestore this is the doc id; otherwise name
          submittedByName: byText || byValRaw,
          date: dateVal,
          menu: menuVal,
          submenu: submenuVal,
          message: msgVal,
          attachments: [],
          createdAt: now,
          updatedAt: now
        };

        // Create doc first (get docId)
        let docId = null;
        if (db){
          if (DF.firestore){
            const { addDoc, collection } = DF.firestore;
            const ref = await addDoc(collection(db,'ideas'), docBody);
            docId = ref.id;
          } else {
            const ref = await db.collection('ideas').add(docBody);
            docId = ref.id;
          }

          // Upload attachments if storage is present
          if (attachments.length && storage){
            const uploadOneCompat = async (path, blob) => {
              const ref = storage.ref(path);
              await ref.put(blob, {contentType:'image/jpeg'});
              return await ref.getDownloadURL();
            };
            const uploaded = [];
            for (let i=0;i<attachments.length;i++){
              const a = attachments[i];
              const path = `ideas/${docId}/${i+1}-${slug(a.name||'image')}.jpg`;
              // dataURL -> Blob
              const b64 = a.dataUrl.split(',')[1]; const len = atob(b64).length;
              const u8 = new Uint8Array(len); for (let j=0;j<len;j++) u8[j] = atob(b64).charCodeAt(j);
              const blob = new Blob([u8], {type:'image/jpeg'});
              let url = '';
              if (DF.storage && DF.storageRef && DF.storageUploadBytes && DF.storageGetDownloadURL){
                const { storageRef, storageUploadBytes, storageGetDownloadURL } = DF;
                const ref = storageRef(storage, path);
                await storageUploadBytes(ref, blob, {contentType:'image/jpeg'});
                url = await storageGetDownloadURL(ref);
              } else {
                url = await uploadOneCompat(path, blob);
              }
              uploaded.push({url, path, w:a.w, h:a.h, bytes:a.bytes});
            }
            // Update doc with attachment metadata
            if (DF.firestore){
              const { doc, updateDoc } = DF.firestore;
              await updateDoc(doc(db,'ideas',docId), { attachments: uploaded, updatedAt: Date.now() });
            } else {
              await db.collection('ideas').doc(docId).update({ attachments: uploaded, updatedAt: Date.now() });
            }
          }
          savedToCloud = true;
        }
      } catch (e){
        console.error('Cloud save failed:', e);
      }

      if (!savedToCloud){
        // Local fallback so submission isn‚Äôt lost
        const k = 'df_ideas_local';
        const list = JSON.parse(localStorage.getItem(k)||'[]');
        list.push({
          permaKey,
          submittedById: $by.value,
          submittedByName: $by.options[$by.selectedIndex]?.textContent || $by.value,
          date: dateVal,
          menu: menuVal,
          submenu: submenuVal,
          message: msgVal,
          attachments: attachments.slice(), // dataURLs
          createdAt: now,
          updatedAt: now,
          _localOnly: true
        });
        localStorage.setItem(k, JSON.stringify(list));
        toast('Saved locally (offline)');
      } else {
        toast('Idea saved');
      }

      // Reset form
      document.getElementById('ideaForm').reset();
      attachments = []; renderShots();
      $date.value = todayCT();
      // Reselect current user if known
      const youName = (window.getCurrentUser && window.getCurrentUser()) || localStorage.getItem('df_current_user') || '';
      if (youName){
        const opt = [...$by.options].find(o => o.textContent === youName);
        if (opt) $by.value = opt.value;
      }
    }

    // ---------- Wire up Save / Clear / Cancel ----------
    document.getElementById('ideaForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      saveIdea();
    });
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      attachments = []; renderShots();
      $date.value = todayCT();
      $msg.value = '';
      toast('Cleared');
    });
    $cancel.addEventListener('click', ()=>{
      // Back to feedback submenu index
      location.href = './index.html';
    });

    // ---------- Menu/Submenu "Other" UX ----------
    function toggleOtherUI(){
      const mIsOther = $menu.value === ADD_OTHER;
      const sIsOther = $sub.value === ADD_OTHER;
      $menuOtherWrap.style.display = mIsOther ? 'flex' : 'none';
      $submenuOtherWrap.style.display = sIsOther ? 'flex' : 'none';
    }
    $menu.addEventListener('change', toggleOtherUI);
    $sub.addEventListener('change', toggleOtherUI);

    // ---------- Bootstrap page ----------
    (async function init(){
      // Employees
      await loadEmployees();

      // Menus/Submenus
      const M = await loadMenusData();
      (function renderMenuOptions(){
        $menu.innerHTML = '';
        Object.keys(M).forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          $menu.appendChild(opt);
        });
        const other = document.createElement('option');
        other.value = ADD_OTHER; other.textContent = 'Other‚Ä¶';
        $menu.appendChild(other);
      })();
      (function renderSubmenuOptions(menuName){
        $sub.innerHTML = '';
        const subs = M[menuName] || [];
        subs.forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          $sub.appendChild(opt);
        });
        const other = document.createElement('option');
        other.value = ADD_OTHER; other.textContent = 'Other‚Ä¶';
        $sub.appendChild(other);
      })($menu.value || Object.keys(M)[0]);

      // React to menu changes
      $menu.addEventListener('change', ()=>{
        const menuName = $menu.value;
        $sub.innerHTML = '';
        const subs = M[menuName] || [];
        subs.forEach(name=>{
          const opt = document.createElement('option');
          opt.value = name; opt.textContent = name;
          $sub.appendChild(opt);
        });
        const other = document.createElement('option');
        other.value = ADD_OTHER; other.textContent = 'Other‚Ä¶';
        $sub.appendChild(other);
        toggleOtherUI();
      });

      toggleOtherUI();
    })();
  })();
  </script>

  <!-- Optional service worker registration; harmless if already handled elsewhere -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("../serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>
