<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Unlock</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2rem; }
    .card { border: 2px solid #1B5E20; padding: 1.5rem; border-radius: 10px; max-width: 500px; }
    h1 { color: #1B5E20; margin-top: 0; }
    .ok { color: green; }
    .err { color: darkred; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Admin Unlock</h1>
    <p>This one-time page seeds the <strong>Administrator</strong> role with full access and assigns your current user to it.</p>
    <p id="status">Checking…</p>
  </div>

  <!-- Load the same Firebase init your app uses -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module">
    import {
      getFirestore, doc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    async function run() {
      try {
        const fb = window.DF_FB;
        if (!fb || !fb.db || !fb.auth) {
          document.getElementById('status').innerHTML =
            '<span class="err">Error: Firebase not initialized. Make sure you are logged in.</span>';
          return;
        }

        const db = getFirestore();
        const user = fb.auth.currentUser;
        if (!user) {
          document.getElementById('status').innerHTML =
            '<span class="err">Error: No user logged in.</span>';
          return;
        }

        // Seed Administrator role
        await setDoc(doc(db, 'roles', 'Administrator'), {
          label: 'Administrator',
          permKey: "Settings & Setup › Account Roles",
          permissions: { "*": { "*": { view:true, edit:true, add:true, archive:true, delete:true } } },
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });

        // Assign current user to Administrator
        const email = user.email.toLowerCase();
        await setDoc(doc(db, 'users', email), {
          id: email,
          email: email,
          roleId: 'Administrator',
          updatedAt: serverTimestamp()
        }, { merge: true });

        document.getElementById('status').innerHTML =
          '<span class="ok">All set! You are now an Administrator.</span>';
      } catch (err) {
        document.getElementById('status').innerHTML =
          '<span class="err">Error: ' + err.message + '</span>';
        console.error(err);
      }
    }

    // Wait for login before running
    setTimeout(run, 1500);
  </script>
</body>
</html>