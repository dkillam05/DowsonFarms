<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Ideas â€” Dowson Farms</title>

  <!-- Styles / App -->
  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/maskable-512.png" />

  <style>
    /* Page-specific: a little extra bottom pad so footer/back never overlap */
    .content { padding-bottom: calc(var(--footer-h) + 120px); }

    /* Uniform rows: fields in the same row stay the same width */
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .row > .field { flex:1 1 0; min-width:260px; }

    .field { margin: 10px 0; }
    .field label { display:block; font-weight:700; color: var(--brand-green); margin-bottom:6px; }

    select,
    input[type="text"],
    input[type="date"],
    textarea{
      width:100%;
      padding:10px;
      border:1px solid var(--tile-border);
      border-radius:8px;
      background: var(--tile-bg);
      color: var(--ink);
      font-size:16px;
      box-sizing:border-box;
    }
    textarea{ min-height:110px; }

    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      outline:none;
      border-color: var(--tile-border);
      box-shadow: 0 0 0 3px rgba(45,106,49,.30);
    }

    .muted { color:#666; font-size:.9rem; }

    /* Submit centered, Clear on right */
    .form-actions{
      margin-top: 16px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }
    .form-actions .center { justify-self: center; }
    .form-actions .right  { justify-self: end; }

    .btn-solid{
      background: var(--brand-green);
      color:#fff;
      border:0; border-radius:12px;
      padding:9px 14px; cursor:pointer;
      font: 600 .95rem 'Playfair Display', serif;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .btn-solid:hover{ background:#154a18; }

    .btn-outline{
      background: var(--tile-bg);
      color: var(--brand-green);
      border:2px solid var(--brand-green);
      border-radius:10px;
      padding:6px 10px; cursor:pointer; font: 600 .9rem 'Playfair Display', serif;
    }
    :root[data-theme="dark"] .btn-outline,
    :root[data-theme="auto"] .btn-outline{ color: var(--ink); border-color: var(--tile-border); }
    .btn-outline:hover{ background:#fefefe; }
  </style>

  <!-- Apply saved theme ASAP before paint -->
  <script>
    (function bootTheme(){
      try {
        const saved = localStorage.getItem('df_theme') || 'auto';
        document.documentElement.setAttribute('data-theme', saved);
      } catch(_) {}
    })();
  </script>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right">
      <span id="clock" class="clock">--:--</span>
    </div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">â€º</li>
      <li><a href="feedback.html">Feedback</a></li>
      <li class="sep">â€º</li>
      <li><span>Ideas</span></li>
    </ol>
  </nav>

  <!-- Content -->
  <main class="content" data-has-form>
    <h1>ðŸ’¡ Ideas</h1>

    <form id="idea-form" novalidate>
      <div class="row">
        <div class="field">
          <label for="submittedBy">Submitted by</label>
          <select id="submittedBy" required></select>
          <small id="whoHint" class="muted"></small>
        </div>
        <div class="field">
          <label for="submittedDate">Date submitted</label>
          <input id="submittedDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="menuSel">Menu</label>
          <select id="menuSel" required></select>
        </div>
        <div class="field">
          <label for="submenuSel">Submenu</label>
          <select id="submenuSel" required></select>
        </div>
      </div>

      <div class="field">
        <label for="message">Message</label>
        <textarea id="message" required placeholder="Describe your ideaâ€¦"></textarea>
      </div>

      <div class="form-actions">
        <div></div>
        <div class="center">
          <button class="btn-solid" type="submit">Submit Idea</button>
        </div>
        <div class="right">
          <button class="btn-outline" type="reset">Clear</button>
        </div>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">â€¢</span>
    <span id="report-date">â€”</span>
    <span class="dot">â€¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <script>
    (function IdeasPage(){
      const ADD_VALUE = "__ADD_NEW__";
      const ADD_LABEL = "Add New";

      // Use global helper if present
      const getCurrentUser = (window.getCurrentUser) ? window.getCurrentUser : () => localStorage.getItem('df_current_user') || '';

      // Seed people if missing
      const EMPLOYEES = JSON.parse(localStorage.getItem('df_people') || '[]');
      if (!EMPLOYEES.length) {
        localStorage.setItem('df_people', JSON.stringify([
          {name:'John Doe'}, {name:'Jane Smith'}, {name:'Sam Operator'}, {name:'Vendor Co.'}
        ]));
      }

      // Menus/Submenus seed
      const DEFAULT_MENUS = {
        "Home": ["â€”"],
        "Crop Production": ["Planting","Spraying","Harvest"],
        "Grain Tracking": ["Bins","Tickets","Contracts"],
        "Equipment": ["Maintenance","Repairs","Assignments"],
        "Calculators": ["Seed Rate","Fertilizer","ROI"],
        "Reports": ["Crops","Equipment","Financial"],
        "Team / Partners": ["Employees","Vendors"],
        "Feedback": ["Ideas","Bugs / Issues"],
        "Setup / Settings": ["Farms","Fields","Theme","Account Roles","Crop Types"]
      };
      const MENUS = JSON.parse(localStorage.getItem('df_menus') || 'null') || DEFAULT_MENUS;

      // DOM
      const bySel = document.getElementById('submittedBy');
      const dateEl = document.getElementById('submittedDate');
      const whoHint = document.getElementById('whoHint');
      const menuSel = document.getElementById('menuSel');
      const submenuSel = document.getElementById('submenuSel');
      const msgEl = document.getElementById('message');
      const form = document.getElementById('idea-form');

      function renderPeople(){
        const people = JSON.parse(localStorage.getItem('df_people'));
        const you = getCurrentUser();
        bySel.innerHTML = '';
        people.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name + (you && you === p.name ? ' (You)' : '');
          bySel.appendChild(opt);
        });
        if (you) {
          const found = [...bySel.options].find(o => o.value === you);
          if (found) bySel.value = you;
        }
        whoHint.textContent = bySel.value ? '' : 'Tip: set df_current_user in localStorage to auto-select you.';
      }

      function addSpecialAddOption(selectEl){
        const opt = document.createElement('option');
        opt.value = ADD_VALUE;
        opt.textContent = ADD_LABEL;
        opt.dataset.add = "1";
        selectEl.appendChild(opt);
      }

      function renderMenus(){
        menuSel.innerHTML = '';
        Object.keys(MENUS).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          menuSel.appendChild(opt);
        });
        addSpecialAddOption(menuSel);
        renderSubmenus(menuSel.value);
      }

      function renderSubmenus(menu){
        submenuSel.innerHTML = '';
        (MENUS[menu] || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          submenuSel.appendChild(opt);
        });
        addSpecialAddOption(submenuSel);
      }

      function todayCT(){
        const now = new Date();
        const parts = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
        const y = parts.find(p=>p.type==='year').value;
        const m = parts.find(p=>p.type==='month').value;
        const d = parts.find(p=>p.type==='day').value;
        return `${y}-${m}-${d}`;
      }

      function saveIdea(data){
        const list = JSON.parse(localStorage.getItem('df_ideas') || '[]');
        list.push(data);
        localStorage.setItem('df_ideas', JSON.stringify(list));
      }

      // Add-new handlers
      function promptCap(msg){
        const raw = prompt(msg);
        if (!raw) return null;
        return raw.trim().replace(/^./, c => c.toUpperCase());
      }

      menuSel.addEventListener('change', () => {
        if (menuSel.value !== ADD_VALUE) {
          renderSubmenus(menuSel.value);
          return;
        }
        const name = promptCap('New menu name:');
        if (!name) { renderMenus(); return; }
        if (!MENUS[name]) MENUS[name] = ['â€”'];
        localStorage.setItem('df_menus', JSON.stringify(MENUS));
        renderMenus();
        menuSel.value = name;
        renderSubmenus(name);
      });

      submenuSel.addEventListener('change', () => {
        if (submenuSel.value !== ADD_VALUE) return;
        const menu = menuSel.value;
        const name = promptCap(`New submenu for "${menu}":`);
        if (!name) { renderSubmenus(menu); return; }
        if (!MENUS[menu]) MENUS[menu] = [];
        if (!MENUS[menu].includes(name)) MENUS[menu].push(name);
        localStorage.setItem('df_menus', JSON.stringify(MENUS));
        renderSubmenus(menu);
        submenuSel.value = name;
      });

      // Init
      renderPeople();
      dateEl.value = todayCT();
      renderMenus();

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!bySel.value || !dateEl.value || !menuSel.value || !submenuSel.value || !msgEl.value.trim()) {
          alert('Please complete all required fields.');
          return;
        }
        const record = {
          submittedBy: bySel.value.replace(/\s+\(You\)$/,''),
          date: dateEl.value,
          menu: menuSel.value,
          submenu: submenuSel.value,
          message: msgEl.value.trim(),
          status: 'open',
          ts: Date.now()
        };
        saveIdea(record);
        form.reset();
        renderPeople();
        dateEl.value = todayCT();
        renderMenus();
        alert('Idea submitted!');
      });

      // Breadcrumbs
      window.setBreadcrumbs?.([
        {label:'Home', href:'index.html'},
        {label:'Feedback', href:'feedback.html'},
        {label:'Ideas'}
      ]);
    })();
  </script>

  <!-- Service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>