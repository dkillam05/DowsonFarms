<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Account Roles ‚Äî Dowson Farms</title>

  <!-- Prepaint theme -->
  <script>
  (function () {
    var pref = localStorage.getItem('df_theme') || 'auto';
    var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', pref === 'auto' ? (dark ? 'dark' : 'light') : pref);
    document.documentElement.style.colorScheme =
      (pref === 'auto' ? (dark ? 'dark' : 'light') : pref) === 'dark' ? 'dark' : 'light';
  })();
  </script>

  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>

  <style>
    /* keep our label to one star no matter what theme.css does */
    #roleLabel::after { content: none !important; }
    .req { color: var(--danger, #b00020); }

    /* permission pills */
    .perm-actions {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
      margin: 10px 0 6px;
    }
    @media (max-width: 420px){
      .perm-actions { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .btn-toggle {
      border-radius: 18px;
      padding: 10px 0;
      text-align: center;
      border: 2px solid var(--btn-outline, #2c6b2f);
      background: var(--tile-bg, #fff);
      color: var(--brand-ink, #264b26);
      font-weight: 600;
    }
    .btn-toggle.is-on {
      background: var(--brand-ink, #1b5e20);
      color: #fff;
      border-color: var(--brand-ink, #1b5e20);
    }

    /* accordion look (stays within card width) */
    details.perm-accordion {
      border: 1px solid var(--tile-border);
      border-radius: 14px;
      background: var(--tile-bg);
      margin: 10px 0;
      overflow: hidden;
    }
    details.perm-accordion > summary {
      list-style: none;
      cursor: pointer;
      padding: 14px 16px;
      font-weight: 700;
      display:flex; align-items:center; gap:10px;
    }
    details.perm-accordion > summary::marker { display:none; }
    details.perm-accordion > summary .caret {
      display:inline-block; width: 12px; height:12px;
      border-right: 2px solid currentColor; border-bottom:2px solid currentColor;
      transform: rotate(-45deg); margin-right:4px;
    }
    details[open] > summary .caret { transform: rotate(45deg); }

    .perm-body { padding: 12px 14px 16px; border-top:1px dashed var(--tile-border); }
    .submenus-wrap {
      border: 2px dashed var(--tile-border);
      border-radius: 12px;
      padding: 10px;
      margin-top: 6px;
      background: var(--tile-bg);
    }

    /* manage submenus row button */
    .manage-row {
      display:flex; align-items:center; justify-content:space-between;
      border: 1px dashed var(--tile-border);
      border-radius: 12px; padding: 12px 14px; margin-top: 8px;
      background: var(--tile-bg);
      font-weight:700;
    }

    /* toast */
    #dfToast { display:none; position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 14px; border-radius:10px; border:1px solid var(--tile-border);
      background:var(--tile-bg, rgba(0,0,0,.03)); box-shadow:0 6px 24px rgba(0,0,0,.12); z-index:9999; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right"><span id="clock" class="clock">--:--</span></div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">‚Ä∫</li>
      <li><a href="settings.html">Setup / Settings</a></li>
      <li class="sep">‚Ä∫</li>
      <li><span>Account Roles</span></li>
    </ol>
  </nav>

  <main class="content" data-has-form>
    <!-- Title row with Quick View -->
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1 style="margin:0;">üõ°Ô∏è Account Roles</h1>
      <button type="button" class="btn-secondary" id="quickViewBtn">Quick View</button>
    </div>

    <!-- Role selector -->
    <section class="card" style="margin-top:12px;">
      <div class="field">
        <label id="roleLabel" for="roleSel">Role <span class="req">*</span></label>
        <select id="roleSel" required>
          <option>Administrator</option>
          <option>Owner</option>
          <option>Manager</option>
          <option>Employee</option>
          <option>View Only</option>
        </select>
      </div>
    </section>

    <!-- Permissions -->
    <section class="card" style="margin-top:12px;">
      <h2 style="margin:0 0 6px;">Permissions</h2>
      <p class="muted" style="margin-top:0;">
        Expand a menu and set what this role can do. Use ‚ÄúManage submenus‚Äù to fine-tune individual screens.
      </p>

      <div id="permRoot"></div>

      <div class="form-actions" style="margin-top:8px;">
        <div></div>
        <button class="btn-primary" id="savePermsBtn" type="button">Save</button>
        <div></div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View modal -->
  <div class="auth-modal__backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(560px,92vw);">
      <h2 id="qvTitle">Role Permissions ‚Äî <span id="qvRole">‚Äî</span></h2>
      <ul id="qvList" style="list-style:disc; padding-left:22px; margin:8px 0 0;"></ul>
      <div class="modal-actions">
        <button class="btn-secondary" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="dfToast"><span id="dfToastText">Saved</span></div>

  <script>
  (function RolesPage(){
    const $ = (s)=>document.querySelector(s);
    const permRoot = $('#permRoot');
    const roleSel = $('#roleSel');

    // --- MENUS (order matches app; "Home" omitted as requested)
    const MENUS = [
      { menu:'Crop Production', sub:['Planting','Spraying','Harvest','Trials','Scouting','Maintenance'] },
      { menu:'Grain Tracking',  sub:['Bins','Tickets','Contracts'] },
      { menu:'Equipment',       sub:['Maintenance','Repairs','Assignments'] },
      { menu:'Calculators',     sub:['Seed Rate','Fertilizer','ROI'] },
      { menu:'Reports',         sub:['Crops','Equipment','Financial'] },
      { menu:'Team / Partners', sub:['Employees','Vendors','Sub-contractors','Dictionary'] },
      { menu:'Feedback',        sub:['Ideas','Bugs / Issues'] },
      { menu:'AI',              sub:['AI','AI History'] },
      { menu:'Setup / Settings',sub:['Farms','Fields','Theme','Account Roles','Crop Types'] },
    ];

    const ACTIONS = ['view','edit','add','archive','del'];
    const actionLabel = {view:'View',edit:'Edit',add:'Add',archive:'Archive',del:'Delete'};

    const STORE_KEY = 'df.rolePerms.v2'; // role -> { [menu]: {all:{..}, sub:{ name:{..} }}}
    const state = loadState();

    function loadState(){
      try { return JSON.parse(localStorage.getItem(STORE_KEY) || '{}'); }
      catch { return {}; }
    }
    function saveState(){ localStorage.setItem(STORE_KEY, JSON.stringify(state)); }

    function getRolePerm(role){
      if(!state[role]){
        // default: View Only: only "view" on everything, others false
        const def = {};
        MENUS.forEach(m=>{
          def[m.menu] = {
            all: {view: role==='View Only', edit:false, add:false, archive:false, del:false},
            sub: Object.fromEntries(m.sub.map(s=>[s,{view: role==='View Only', edit:false, add:false, archive:false, del:false}]))
          };
        });
        state[role] = def;
      }
      return state[role];
    }

    function render(){
      permRoot.innerHTML = '';
      const data = getRolePerm(roleSel.value);

      MENUS.forEach(group=>{
        const details = document.createElement('details');
        details.className = 'perm-accordion'; // collapsed by default

        const summary = document.createElement('summary');
        summary.innerHTML = `<span class="caret"></span> ${group.menu}`;
        details.appendChild(summary);

        const body = document.createElement('div');
        body.className = 'perm-body';

        // Top-level actions (apply to ALL submenus inside this menu)
        const topRow = document.createElement('div');
        topRow.className = 'perm-actions';
        ACTIONS.forEach(a=>{
          const btn = document.createElement('button');
          btn.type='button';
          btn.className = 'btn-toggle' + (data[group.menu].all[a] ? ' is-on' : '');
          btn.textContent = actionLabel[a];
          btn.addEventListener('click', ()=>{
            data[group.menu].all[a] = !data[group.menu].all[a];
            btn.classList.toggle('is-on');
          });
          topRow.appendChild(btn);
        });
        body.appendChild(topRow);

        // Manage submenus (expander)
        const manage = document.createElement('div');
        manage.className = 'manage-row';
        manage.innerHTML = `<span>Manage submenus</span><span aria-hidden="true">‚Ä∫</span>`;
        body.appendChild(manage);

        const subWrap = document.createElement('div');
        subWrap.className = 'submenus-wrap';
        subWrap.style.display = 'none';

        group.sub.forEach(name=>{
          const row = document.createElement('div');
          row.style.margin = '10px 0 12px';

          const title = document.createElement('div');
          title.style.fontWeight = '700';
          title.style.marginBottom = '6px';
          title.textContent = `${group.menu} ‚Ä∫ ${name}`;
          row.appendChild(title);

          const actions = document.createElement('div');
          actions.className = 'perm-actions';
          ACTIONS.forEach(a=>{
            const btn = document.createElement('button');
            btn.type='button';
            btn.className = 'btn-toggle' + (data[group.menu].sub[name][a] ? ' is-on' : '');
            btn.textContent = actionLabel[a];
            btn.addEventListener('click', ()=>{
              data[group.menu].sub[name][a] = !data[group.menu].sub[name][a];
              btn.classList.toggle('is-on');
            });
            actions.appendChild(btn);
          });
          row.appendChild(actions);
          subWrap.appendChild(row);
        });

        manage.addEventListener('click', ()=>{
          subWrap.style.display = (subWrap.style.display === 'none') ? 'block' : 'none';
        });

        body.appendChild(subWrap);
        details.appendChild(body);
        permRoot.appendChild(details);
      });
    }

    // Save handler: persist, collapse everything, scroll top, toast
    $('#savePermsBtn').addEventListener('click', ()=>{
      saveState();
      toast('Permissions saved');
      document.querySelectorAll('.perm-accordion[open]').forEach(d=>d.removeAttribute('open'));
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Switch role
    roleSel.addEventListener('change', render);

    // Quick View summary
    const qvBtn = $('#quickViewBtn'), qvBackdrop = $('#qvBackdrop'), qvList = $('#qvList'), qvRole = $('#qvRole');
    qvBtn.addEventListener('click', ()=>{
      const data = getRolePerm(roleSel.value);
      qvRole.textContent = roleSel.value;
      qvList.innerHTML = '';
      MENUS.forEach(group=>{
        const li = document.createElement('li');
        li.style.margin='8px 0';
        li.innerHTML = `<strong>${group.menu}</strong> ‚Äî ${summarizeMenu(data[group.menu], group.sub)}`;
        qvList.appendChild(li);
      });
      qvBackdrop.style.display='flex';
    });
    $('#qvClose').addEventListener('click', ()=> qvBackdrop.style.display='none');
    qvBackdrop.addEventListener('click', (e)=>{ if(e.target===qvBackdrop) qvBackdrop.style.display='none'; });

    function summarizeMenu(entry, subs){
      // If ALL actions true across ALL submenus, say "All"
      const allTrue = ACTIONS.every(a=> entry.all[a]) && subs.every(s=> ACTIONS.every(a=> entry.sub[s][a]));
      if (allTrue) return 'All';

      // actions that are on for every submenu
      const onEvery = ACTIONS.filter(a=> subs.every(s=> !!entry.sub[s][a]));
      const hasExceptions =
        subs.some(s => ACTIONS.some(a => entry.sub[s][a] !== entry.sub[subs[0]][a])) ||
        ACTIONS.some(a => entry.all[a] !== onEvery.includes(a));

      let line = onEvery.length ? onEvery.map(a=>actionLabel[a]).join(', ') : 'Custom';
      if (hasExceptions) line += ' (some exceptions)';
      return line;
    }

    function toast(msg){ const box=$('#dfToast'),txt=$('#dfToastText');
      txt.textContent=msg||'Saved';
      box.style.display='block'; clearTimeout(window.__t);
      window.__t=setTimeout(()=>box.style.display='none',1800);
    }

    // init
    render();

    // breadcrumbs (safety)
    window.setBreadcrumbs?.([
      {label:'Home', href:'index.html'},
      {label:'Setup / Settings', href:'settings.html'},
      {label:'Account Roles'}
    ]);
  })();
  </script>

  <!-- Service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>