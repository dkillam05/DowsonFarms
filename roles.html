<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Account Roles ‚Äî Dowson Farms</title>
  <script>
    (function () {
      const pref = localStorage.getItem('df_theme') || 'auto';
      const dark = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
      const theme = pref === 'auto' ? (dark ? 'dark' : 'light') : pref;
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
    })();
  </script>
  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>
  <style>
    /* Small local helpers to match your theme */
    .perm-pill {
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 18px; border-radius:999px; border:2px solid var(--btn-border, #1b5e20);
      background:var(--btn-bg, #fff); color:var(--btn-fg, #1b5e20); font-weight:600;
      min-width:92px; user-select:none;
    }
    .perm-pill[aria-pressed="true"] {
      background:#1b5e20; color:#fff; border-color:#1b5e20;
    }
    .perm-grid { display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
    .menu-card { border:1px solid var(--tile-border); border-radius:16px; overflow:hidden; }
    .menu-head { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; }
    .menu-body { padding:16px; border-top:1px dashed var(--tile-border); }
    .submenu-box { margin-top:16px; border:1px dashed var(--tile-border); border-radius:12px; padding:14px; }
    .submenu-title { font-weight:700; margin-bottom:10px; }
    .row-between { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .muted-small { color:var(--muted-fg); font-size:.95rem; }
    .toast { position:fixed; left:50%; bottom:18px; transform:translateX(-50%); padding:10px 14px;
      border-radius:10px; border:1px solid var(--tile-border); background:var(--tile-bg, rgba(0,0,0,.03));
      box-shadow:0 6px 24px rgba(0,0,0,.12); z-index:9999; display:none; }
    details.app-accordion > summary { list-style:none; }
    details.app-accordion > summary::-webkit-details-marker{ display:none; }
    summary .chev { transition: transform .2s ease; }
    details[open] summary .chev { transform: rotate(90deg); }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right"><span id="clock" class="clock">--:--</span></div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">‚Ä∫</li>
      <li><a href="settings.html">Setup / Settings</a></li>
      <li class="sep">‚Ä∫</li>
      <li><span>Account Roles</span></li>
    </ol>
  </nav>

  <main class="content" data-has-form>
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1 style="margin:0;">üõ°Ô∏è Account Roles</h1>
      <button class="btn-secondary" id="quickViewBtn">Quick View</button>
    </div>

    <form id="roles-form" class="card" style="margin-top:12px;" novalidate>
      <div class="field">
        <label for="roleSel">Role <span aria-hidden="true" style="color:red">*</span></label>
        <select id="roleSel" required>
          <option>Administrator</option>
          <option>Owner</option>
          <option>Manager</option>
          <option>Employee</option>
          <option>View Only</option>
        </select>
      </div>

      <section style="margin-top:8px;">
        <h2 style="margin:0 0 6px 0;">Permissions</h2>
        <p class="muted" style="margin:0 0 14px 0;">Expand a menu and set what this role can do. Use ‚ÄúManage submenus‚Äù to fine-tune individual screens.</p>

        <div id="menusWrap" class="stack"></div>
      </section>

      <section class="card" style="padding:12px; margin-top:12px;">
        <div class="row" style="justify-content:center; gap:10px; flex-wrap:wrap;">
          <button class="btn-primary" type="submit">Save</button>
          <button class="btn-outline" type="button" id="resetBtn">Reset</button>
        </div>
      </section>
    </form>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View modal -->
  <div class="auth-modal__backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(560px,92vw);">
      <h2 id="qvTitle">Role Permissions ‚Äî <span id="qvRole">‚Äî</span></h2>
      <ul id="qvList" style="list-style:disc; padding-left:18px; margin:10px 0 0;"></ul>
      <div class="modal-actions">
        <button class="btn-secondary" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="dfToast" class="toast"><span id="dfToastText">Saved</span></div>

  <script>
  (function RolesPage(){
    const MENUS_ORDER = [
      'Crop Production','Grain Tracking','Equipment','Calculators','Reports','Team / Partners','Feedback','AI','Setup / Settings'
    ];
    const DEFAULT_MENUS = {
      "Crop Production": ["Planting","Spraying","Harvest","Trials","Scouting","Maintenance"],
      "Grain Tracking": ["Bins","Tickets","Contracts"],
      "Equipment": ["Maintenance","Repairs","Assignments"],
      "Calculators": ["Seed Rate","Fertilizer","ROI"],
      "Reports": ["Crops","Equipment","Financial"],
      "Team / Partners": ["Employees","Vendors","Sub-contractors","Dictionary"],
      "Feedback": ["Ideas","Bugs / Issues"],
      "AI": ["AI","AI History"],
      "Setup / Settings": ["Farms","Fields","Theme","Account Roles","Crop Types"]
    };

    const ROLES_KEY = 'df.role.perms';  // { "Administrator": { menu: { _menu:{v,e,a,r,d}, "Sub":{...} } } }
    const $ = (s)=>document.querySelector(s);

    const PERMS = ['view','edit','add','archive','delete'];
    const LABEL = {view:'View', edit:'Edit', add:'Add', archive:'Archive', delete:'Delete'};

    const roleSel = $('#roleSel');
    const wrap = $('#menusWrap');

    function loadPerms(){
      try { return JSON.parse(localStorage.getItem(ROLES_KEY)||'{}'); }
      catch(_) { return {}; }
    }
    function savePerms(obj){
      localStorage.setItem(ROLES_KEY, JSON.stringify(obj));
    }
    function getRolePerms(role){
      const all = loadPerms();
      if(!all[role]) all[role] = {};
      return all[role];
    }
    function setRolePerms(role, data){
      const all = loadPerms();
      all[role] = data;
      savePerms(all);
    }

    function pill(active){
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'perm-pill';
      b.setAttribute('aria-pressed', active ? 'true' : 'false');
      b.addEventListener('click', ()=> {
        const now = b.getAttribute('aria-pressed') === 'true';
        b.setAttribute('aria-pressed', now ? 'false' : 'true');
      });
      return b;
    }

    function menuRow(title){
      const details = document.createElement('details');
      details.className = 'app-accordion menu-card';
      details.open = false;

      const sum = document.createElement('summary');
      sum.className = 'menu-head';
      sum.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px;">
          <span class="chev">‚Ä∫</span>
          <strong>${title}</strong>
        </div>
      `;
      const body = document.createElement('div'); body.className = 'menu-body';

      details.appendChild(sum);
      details.appendChild(body);
      return {details, body};
    }

    function subBox(menu, sub, state){
      const box = document.createElement('div');
      box.className = 'submenu-box';
      const title = document.createElement('div');
      title.className = 'submenu-title';
      title.textContent = `${menu} ‚Ä∫ ${sub}`;
      const grid = document.createElement('div');
      grid.className = 'perm-grid';

      const pills = {};
      PERMS.forEach(p=>{
        const btn = pill(!!state[p]);
        btn.textContent = LABEL[p];
        pills[p]=btn;
        grid.appendChild(btn);
      });

      box.appendChild(title);
      box.appendChild(grid);
      return {box, pills};
    }

    function readPills(pills){
      const out={}; PERMS.forEach(p=>out[p]=pills[p].getAttribute('aria-pressed')==='true'); return out;
    }
    function setPills(pills, val){
      PERMS.forEach(p=>pills[p].setAttribute('aria-pressed', val[p] ? 'true' : 'false'));
    }

    function emptyPerms(){ const o={}; PERMS.forEach(p=>o[p]=false); return o; }
    function allPerms(){ const o={}; PERMS.forEach(p=>o[p]=true); return o; }

    function menuSummaryState(menuPerms, subs){
      // Determine All / None / Custom for a menu
      const values = subs.map(s=>JSON.stringify(menuPerms[s]||emptyPerms()));
      if(!values.length) return 'No access';
      const allFalse = values.every(v=>v===JSON.stringify(emptyPerms()));
      const allTrue  = values.every(v=>v===JSON.stringify(allPerms()));
      if(allTrue) return 'All';
      if(allFalse) return 'No access';
      return 'Custom';
    }

    function render(){
      wrap.innerHTML='';
      const role = roleSel.value;
      const perms = getRolePerms(role);

      MENUS_ORDER.forEach(menu=>{
        const subs = (DEFAULT_MENUS[menu]||[]).slice(); // keep your app order
        if(!perms[menu]) perms[menu]={};
        const {details, body} = menuRow(menu);

        // Top-level controls
        const top = document.createElement('div');
        top.innerHTML = `<div class="muted-small" style="margin-bottom:8px;">Toggle entire menu</div>`;
        const grid = document.createElement('div'); grid.className='perm-grid';
        const topPills={};
        PERMS.forEach(p=>{
          const any = subs.some(s=>perms[menu][s]?.[p]);
          const all = subs.length && subs.every(s=>perms[menu][s]?.[p]);
          const active = all; // show active only if all submenus have it
          const b = pill(active); b.textContent = LABEL[p];
          b.addEventListener('click', ()=>{
            const on = b.getAttribute('aria-pressed')==='true';
            // Apply to ALL submenus under this menu
            subs.forEach(s=>{
              if(!perms[menu][s]) perms[menu][s]=emptyPerms();
              perms[menu][s][p]=!on;
              // also update visible sub-box if present
              const ref = document.querySelector(`[data-sub="${menu}:::${s}"]`);
              if(ref){
                const btn = ref.querySelector(`[data-perm="${p}"]`);
                if(btn) btn.setAttribute('aria-pressed', !on ? 'true' : 'false');
              }
            });
          });
          topPills[p]=b;
          grid.appendChild(b);
        });
        top.appendChild(grid);
        body.appendChild(top);

        // Manage submenus toggle
        const manage = document.createElement('details');
        manage.className='submenu-box';
        manage.innerHTML = `
          <summary class="row-between">
            <span style="font-weight:700;">Manage submenus</span>
            <span class="chev">‚Ä∫</span>
          </summary>
        `;
        const subWrap = document.createElement('div'); subWrap.style.marginTop='10px';
        manage.appendChild(subWrap);

        subs.forEach(sub=>{
          if(!perms[menu][sub]) perms[menu][sub]=emptyPerms();
          const {box, pills} = subBox(menu, sub, perms[menu][sub]);
          // mark for live sync with top toggles
          box.setAttribute('data-sub', `${menu}:::${sub}`);
          PERMS.forEach(p=>{
            pills[p].setAttribute('data-perm', p);
            pills[p].addEventListener('click', ()=>{
              const state = readPills(pills);
              perms[menu][sub] = state;
            });
          });
          subWrap.appendChild(box);
        });

        body.appendChild(manage);
        wrap.appendChild(details);
      });
    }

    // Quick View (summary)
    function openSummary(){
      const role = roleSel.value;
      const perms = getRolePerms(role);
      $('#qvRole').textContent = role;

      const listEl = $('#qvList'); listEl.innerHTML='';
      MENUS_ORDER.forEach(menu=>{
        const subs = DEFAULT_MENUS[menu]||[];
        const state = menuSummaryState(perms[menu]||{}, subs);
        const li = document.createElement('li');
        li.innerHTML = `<strong>${menu}</strong> ‚Äî ${state === 'All' ? 'All' : state === 'No access' ? 'No access' : 'Custom'}`;
        listEl.appendChild(li);
      });
      $('#qvBackdrop').style.display='flex';
    }
    function closeSummary(){ $('#qvBackdrop').style.display='none'; }

    function toast(msg){
      const box=$('#dfToast'),txt=$('#dfToastText'); txt.textContent=msg||'Saved';
      box.style.display='block'; clearTimeout(window.__t);
      window.__t=setTimeout(()=>box.style.display='none',1600);
    }

    $('#roles-form').addEventListener('submit', (e)=>{
      e.preventDefault();
      const role = roleSel.value;
      // collect from DOM we rendered (perms object was mutated live)
      const data = getRolePerms(role);
      setRolePerms(role, data);
      toast('Permissions saved');
      // collapse everything & scroll to top
      document.querySelectorAll('details.app-accordion').forEach(d=>d.open=false);
      window.scrollTo({top:0, behavior:'smooth'});
    });

    $('#resetBtn').addEventListener('click', ()=>{
      // Clear role perms (No access everywhere)
      const role = roleSel.value;
      const base={};
      MENUS_ORDER.forEach(m=>{
        base[m]={};
        (DEFAULT_MENUS[m]||[]).forEach(s=>base[m][s]=emptyPerms());
      });
      setRolePerms(role, base);
      render();
      toast('Reset');
    });

    roleSel.addEventListener('change', render);

    $('#quickViewBtn').addEventListener('click', openSummary);
    $('#qvClose').addEventListener('click', closeSummary);
    $('#qvBackdrop').addEventListener('click', (e)=>{ if(e.target.id==='qvBackdrop') closeSummary(); });

    // Ensure data exists for each role at least once
    (function seedRoles(){
      const all = loadPerms();
      ['Administrator','Owner','Manager','Employee','View Only'].forEach(r=>{
        if(!all[r]){
          all[r]={};
          MENUS_ORDER.forEach(m=>{
            all[r][m]={};
            (DEFAULT_MENUS[m]||[]).forEach(s=>all[r][m][s]=emptyPerms());
          });
        }
      });
      savePerms(all);
    })();

    render();

    // Safety breadcrumbs (if your core.js supplies setBreadcrumbs)
    window.setBreadcrumbs?.([
      {label:'Home', href:'index.html'},
      {label:'Setup / Settings', href:'settings.html'},
      {label:'Account Roles'}
    ]);
  })();
  </script>

  <!-- SW (unchanged) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>