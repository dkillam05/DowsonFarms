<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Fields â€” Dowson Farms</title>
  <script>
  (function () {
    var pref = localStorage.getItem('df_theme') || 'auto';
    var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    document.documentElement.setAttribute('data-theme', pref === 'auto' ? (dark ? 'dark' : 'light') : pref);
    document.documentElement.style.colorScheme = (pref === 'auto' ? (dark ? 'dark' : 'light') : pref) === 'dark' ? 'dark' : 'light';
  })();
  </script>

  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>

  <style>
    #searchInput{font-size:16px;height:44px;padding:10px 14px;border-radius:12px;width:100%}
    .grid2 {display:grid;gap:10px;grid-template-columns:92px 92px;justify-content:center}
    .inline-grow{display:flex;gap:10px;align-items:center}
    .inline-grow > input{flex:1}
    .badge {padding:2px 8px;border-radius:999px;border:1px solid var(--tile-border);font-size:.85rem}
    .muted-sm {opacity:.72;font-size:.92rem}
    .tbl {width:100%; border-collapse:collapse}
    .tbl th,.tbl td{border-bottom:1px solid var(--tile-border); padding:6px 8px; text-align:left}
    .field .hint{font-size:.9rem; opacity:.75; margin-top:4px}
  </style>
</head>
<body>
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right"><span id="clock" class="clock">--:--</span></div>
  </header>

  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">â€º</li>
      <li><a href="settings.html">Setup / Settings</a></li>
      <li class="sep">â€º</li>
      <li><span>Fields</span></li>
    </ol>
  </nav>

  <main class="content" data-has-form>
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1 style="margin:0;">ðŸ§­ Fields</h1>
      <button type="button" class="btn-secondary" id="quickViewBtn">Quick View</button>
    </div>
    <div style="margin-top:12px;"></div>

    <!-- FORM -->
    <form id="field-form" novalidate>
      <!-- Field name -->
      <div class="field">
        <label for="fieldName">Field <span class="req-star">*</span></label>
        <input id="fieldName" type="text" required placeholder="Type field nameâ€¦" />
      </div>

      <!-- Tillable acres -->
      <div class="field">
        <label for="acres">Tillable acres <span class="req-star">*</span></label>
        <input id="acres" type="text" inputmode="decimal" placeholder="e.g., 80 or 80.25" required />
      </div>

      <!-- Farm picker -->
      <div class="field" id="farmField">
        <label for="farmSel">Farm</label>
        <select id="farmSel" style="display:none"></select>
        <div id="farmSearchWrap" class="inline-grow" style="display:none">
          <input id="farmSearch" list="farmList" placeholder="Search farmsâ€¦"/>
          <datalist id="farmList"></datalist>
          <button type="button" class="btn-outline" id="farmAddBtn" title="Add farm">+ Add</button>
        </div>
        <div class="muted-sm">Optional â€” you can bulk-assign under Farms â†’ Manage Fields.</div>
      </div>

      <!-- County (optional) -->
      <div class="field" id="countyField">
        <label for="countySel">County</label>
        <select id="countySel" style="display:none"></select>
        <div id="countySearchWrap" class="inline-grow" style="display:none">
          <input id="countySearch" list="countyList" placeholder="Search countiesâ€¦" />
          <datalist id="countyList"></datalist>
          <button type="button" class="btn-outline" id="countyAddBtn" title="Add county">+ Add</button>
        </div>
      </div>

      <!-- RTK Tower (REQUIRED) -->
      <div class="field" id="rtkField">
        <label for="rtkSel">RTK Tower location <span class="req-star">*</span></label>
        <!-- <=10 towers -->
        <select id="rtkSel" style="display:none"></select>
        <!-- >10 towers -->
        <div id="rtkSearchWrap" class="inline-grow" style="display:none">
          <input id="rtkSearch" list="rtkList" placeholder="Search towersâ€¦"/>
          <datalist id="rtkList"></datalist>
          <button type="button" class="btn-outline" id="rtkAddBtn" title="Add RTK Tower">+ Add</button>
        </div>
        <div class="hint">Towers are saved with <strong>Name</strong>, <strong>Network ID (4 digits)</strong>, and <strong>Radio Frequency</strong> (up to 5 decimals).</div>
      </div>

      <section class="card" style="padding:12px; margin-top:8px;">
        <div class="grid2">
          <button class="btn-primary" type="submit" id="saveBtn" style="width:92px;height:92px;">Save</button>
          <button class="btn-outline" type="reset" id="clearBtn" style="width:92px;height:92px;">Clear</button>
        </div>
      </section>

      <input type="hidden" id="editingId" />
    </form>

    <!-- Import (CSV) -->
    <section class="card" style="margin-top:16px;">
      <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
        <h2 style="margin:0;">Import</h2>
        <button type="button" class="btn-secondary" id="importBtn">Import CSV</button>
      </div>
      <div class="muted-sm" style="margin-top:6px;">Columns supported: Field Name (required), Tillable Acres (required), Farm (optional), County (optional).</div>
    </section>

    <!-- SAVED -->
    <section class="card" id="savedCard" style="margin-top:16px;">
      <h2 style="margin:0 0 8px 0;">Saved Fields</h2>
      <div class="row" style="align-items:center; gap:12px;">
        <input id="searchInput" class="search" type="search" placeholder="Search fieldsâ€¦" />
        <label class="muted" for="toggleShowArchived">
          <input type="checkbox" id="toggleShowArchived" /> Show archived
        </label>
      </div>
      <ul id="savedList" style="list-style:none; padding:0; margin:12px 0 0;"></ul>
    </section>
  </main>

  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">â€¢</span>
    <span id="report-date">â€”</span>
    <span class="dot">â€¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View -->
  <div class="auth-modal__backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(560px,92vw);">
      <h2 id="qvTitle">Fields</h2>
      <ul class="qv-list" id="qvList" style="list-style:none; padding:0; margin:8px 0 0;"></ul>
      <div class="modal-actions">
        <button class="btn-secondary" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Add RTK Tower Modal -->
  <div class="auth-modal__backdrop" id="rtkBackdrop" role="dialog" aria-modal="true" aria-labelledby="rtkTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(520px,94vw);">
      <h2 id="rtkTitle">Add RTK Tower</h2>
      <form id="rtkForm">
        <div class="field">
          <label for="rtkName">Name <span class="req-star">*</span></label>
          <input id="rtkName" type="text" required placeholder="e.g., Pittsfield North" />
        </div>
        <div class="field">
          <label for="rtkNet">Network ID (4 digits) <span class="req-star">*</span></label>
          <input id="rtkNet" type="text" inputmode="numeric" pattern="\\d{4}" maxlength="4" required placeholder="e.g., 1042" />
        </div>
        <div class="field">
          <label for="rtkFreq">Radio frequency (Hz/MHz) <span class="req-star">*</span></label>
          <input id="rtkFreq" type="text" inputmode="decimal" placeholder="e.g., 462.53715" required />
          <div class="hint">Digits with optional decimal and up to <strong>5 digits</strong> after the decimal.</div>
        </div>
        <div class="modal-actions" style="justify-content:space-between; margin-top:10px;">
          <button type="button" class="btn-outline" id="rtkCancel">Cancel</button>
          <button type="submit" class="btn-primary">Save Tower</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Import Modal (unchanged) -->
  <div class="auth-modal__backdrop" id="impBackdrop" role="dialog" aria-modal="true" aria-labelledby="impTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(860px,96vw);">
      <h2 id="impTitle">Import Fields (CSV)</h2>
      <div id="impStep1">
        <input id="impFile" type="file" accept=".csv" />
        <div class="muted-sm" style="margin-top:6px;">Weâ€™ll auto-detect headers; you can adjust the mapping.</div>
      </div>
      <div id="impStep2" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px 0;">Map Columns</h3>
        <div class="row" style="gap:10px; flex-wrap:wrap;">
          <label>Field Name <select id="mapName"></select></label>
          <label>Tillable Acres <select id="mapAcres"></select></label>
          <label>Farm <select id="mapFarm"></select></label>
          <label>County <select id="mapCounty"></select></label>
        </div>
        <div class="muted-sm" style="margin-top:6px;">Unmapped optional columns will be ignored.</div>
      </div>
      <div id="impStep3" style="display:none; margin-top:12px;">
        <h3 style="margin:0 0 8px 0;">Preview</h3>
        <div id="impPreview" style="max-height:min(48vh,460px); overflow:auto; border:1px solid var(--tile-border); border-radius:10px;"></div>
      </div>
      <div class="modal-actions" style="justify-content:space-between; margin-top:12px;">
        <button class="btn-outline" id="impCancel">Cancel</button>
        <div>
          <button class="btn-outline" id="impBack" style="display:none;">Back</button>
          <button class="btn-primary" id="impNext" disabled>Next</button>
          <button class="btn-primary" id="impCommit" style="display:none;">Import</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function FieldsPage(){
    const FIELD_KEY='df.fields';
    const FARM_KEY='df.farms';
    const COUNTY_KEY='df.counties';
    const TOWER_KEY='df.rtk.towers';
    const ADD_VALUE='__ADD__';

    const $=s=>document.querySelector(s);
    const $$=(s)=>Array.from(document.querySelectorAll(s));
    const setText=(sel,txt)=>{ const el=$(sel); if(el) el.textContent=txt; };

    const $id=$('#editingId');
    const $name=$('#fieldName');
    const $acres=$('#acres');
    const $saved=$('#savedList');

    // Farm controls
    const $farmSel=$('#farmSel');
    const $farmSearchWrap=$('#farmSearchWrap');
    const $farmSearch=$('#farmSearch');
    const $farmList=$('#farmList');
    const $farmAddBtn=$('#farmAddBtn');

    // County controls
    const $countySel=$('#countySel');
    const $countySearchWrap=$('#countySearchWrap');
    const $countySearch=$('#countySearch');
    const $countyList=$('#countyList');
    const $countyAddBtn=$('#countyAddBtn');

    // RTK Tower controls
    const $rtkSel=$('#rtkSel');
    const $rtkSearchWrap=$('#rtkSearchWrap');
    const $rtkSearch=$('#rtkSearch');
    const $rtkList=$('#rtkList');
    const $rtkAddBtn=$('#rtkAddBtn');

    // RTK Modal elems
    const rtkBackdrop=$('#rtkBackdrop');
    const rtkForm=$('#rtkForm');
    const rtkName=$('#rtkName');
    const rtkNet=$('#rtkNet');
    const rtkFreq=$('#rtkFreq');

    // Title-case helper
    function titleCase(s){ return (s||'').toLowerCase().replace(/\b([a-z])/g,c=>c.toUpperCase()); }

    // Storage helpers
    function load(k){ try{return JSON.parse(localStorage.getItem(k)||'[]')}catch(_){return[]} }
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)) }

    // Farms list
    function listFarms(){ return load(FARM_KEY).sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'})); }
    function upsertFarmByName(name){
      const nm=titleCase((name||'').trim()); if(!nm) return null;
      const id=nm.toLowerCase();
      const farms=listFarms();
      if(!farms.find(f=>f.id===id)){
        farms.push({id, name:nm, archived:false, createdAt:Date.now(), updatedAt:Date.now()});
        save(FARM_KEY, farms);
      }
      return id;
    }

    // Counties list
    function listCounties(){ return load(COUNTY_KEY).sort((a,b)=>a.localeCompare(b)); }
    function addCountyRaw(name){
      const nm=titleCase((name||'').trim()); if(!nm) return null;
      const list=listCounties();
      if(!list.includes(nm)){ list.push(nm); save(COUNTY_KEY,list); }
      return nm;
    }

    // RTK Towers
    function listTowers(){
      return load(TOWER_KEY).sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
    }
    function validNetId(v){ return /^\d{4}$/.test(String(v||'')); }
    function validFreq(v){ return /^\d+(?:\.\d{1,5})?$/.test(String(v||'')); } // up to 5 decimals
    function upsertTower({name, networkId, freq}){
      const nm=titleCase((name||'').trim());
      const net=String(networkId||'').trim();
      const fq=String(freq||'').trim();
      if(!nm || !validNetId(net) || !validFreq(fq)) return null;
      const id = nm.toLowerCase(); // key by name
      const list=load(TOWER_KEY);
      const i=list.findIndex(t=>t.id===id);
      const rec={id, name:nm, networkId:net, freq:fq, createdAt: list[i]?.createdAt || Date.now(), updatedAt: Date.now()};
      if(i>=0) list[i]=rec; else list.push(rec);
      save(TOWER_KEY, list);
      return id;
    }
    function towerById(id){ return listTowers().find(t=>t.id===id); }

    // Fields CRUD
    function getField(id){ return load(FIELD_KEY).find(x=>x.id===id) }
    function upsertField(item){
      const list=load(FIELD_KEY);
      const i=list.findIndex(x=>x.id===item.id);
      if(i>=0) list[i]=item; else list.push(item);
      save(FIELD_KEY,list);
    }

    // Enforce acres 0â€“2 decimals
    function wireAcres(el){
      el.addEventListener('keydown',(e)=>{
        const bad=['e','E','+','-']; if(bad.includes(e.key)) return e.preventDefault();
        if(['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Enter'].includes(e.key)) return;
        if(e.key==='.' && el.value.includes('.')) return e.preventDefault();
        if(!/^\d$/.test(e.key) && e.key!=='.') e.preventDefault();
      });
      el.addEventListener('input',()=>{
        let v=el.value.replace(/[^0-9.]/g,'');
        const i=v.indexOf('.');
        if(i!==-1){ v=v.slice(0,i+1)+v.slice(i+1).replace(/\./g,''); v=v.replace(/^(\d+\.\d{0,2}).*$/,'$1'); }
        el.value=v; el.selectionStart=el.selectionEnd=el.value.length;
      });
    }
    wireAcres($acres);

    /* ---------- Farm control ---------- */
    function renderFarmControl(selectedIdOrName){
      const farms=listFarms();
      const many=farms.length>10;

      if(!many){
        $farmSearchWrap.style.display='none';
        $farmSel.style.display='block';
        $farmSel.innerHTML='';
        const empty=document.createElement('option'); empty.value=''; empty.textContent='â€” Unassigned â€”'; $farmSel.appendChild(empty);
        farms.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name; $farmSel.appendChild(o); });
        const add=document.createElement('option'); add.value=ADD_VALUE; add.textContent='âž• Add New Farmâ€¦'; $farmSel.appendChild(add);
        if(selectedIdOrName){
          const id = farms.find(f=>f.id===selectedIdOrName || f.name===selectedIdOrName)?.id || '';
          $farmSel.value=id;
        } else $farmSel.value='';
      } else {
        $farmSel.style.display='none';
        $farmSearchWrap.style.display='flex';
        $farmList.innerHTML=farms.map(f=>`<option value="${f.name}">`).join('');
        $farmSearch.value = selectedIdOrName && farms.find(f=>f.id===selectedIdOrName)?.name || '';
      }
    }
    $farmSel.addEventListener('change', ()=>{
      if($farmSel.value!==ADD_VALUE) return;
      const raw=prompt('New farm name:'); if(!raw){ renderFarmControl(); return; }
      const id=upsertFarmByName(raw);
      renderFarmControl(id);
    });
    $farmAddBtn.addEventListener('click', ()=>{
      const raw = $farmSearch.value || prompt('New farm name:');
      const id=upsertFarmByName(raw);
      const farms=listFarms(); const f=farms.find(x=>x.id===id);
      $farmSearch.value = f?.name || '';
      renderFarmControl(id);
    });

    /* ---------- County control ---------- */
    function renderCountyControl(selected){
      const counties=listCounties();
      const many=counties.length>10;

      if(!many){
        $countySearchWrap.style.display='none';
        $countySel.style.display='block';
        $countySel.innerHTML='';
        const empty=document.createElement('option'); empty.value=''; empty.textContent='â€” None â€”'; $countySel.appendChild(empty);
        counties.forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; $countySel.appendChild(o); });
        const add=document.createElement('option'); add.value=ADD_VALUE; add.textContent='âž• Add New Countyâ€¦'; $countySel.appendChild(add);
        $countySel.value = selected || '';
      } else {
        $countySel.style.display='none';
        $countySearchWrap.style.display='flex';
        $countyList.innerHTML=counties.map(c=>`<option value="${c}">`).join('');
        $countySearch.value = selected || '';
      }
    }
    $countySel.addEventListener('change', ()=>{
      if($countySel.value!==ADD_VALUE) return;
      const raw=prompt('New county name:'); if(!raw){ renderCountyControl(); return; }
      const val=addCountyRaw(raw);
      renderCountyControl(val);
    });
    $countyAddBtn.addEventListener('click', ()=>{
      const raw=$countySearch.value || prompt('New county name:');
      const val=addCountyRaw(raw);
      renderCountyControl(val);
    });

    /* ---------- RTK Tower control (REQUIRED) ---------- */
    function renderRtkControl(selectedIdOrName){
      const towers=listTowers();
      const many=towers.length>10;

      if(!many){
        $rtkSearchWrap.style.display='none';
        $rtkSel.style.display='block';
        $rtkSel.innerHTML='';
        const empty=document.createElement('option'); empty.value=''; empty.textContent='â€” Select tower â€”'; $rtkSel.appendChild(empty);
        towers.forEach(t=>{
          const o=document.createElement('option');
          o.value=t.id;
          o.textContent=`${t.name}`;
          $rtkSel.appendChild(o);
        });
        const add=document.createElement('option'); add.value=ADD_VALUE; add.textContent='âž• Add New RTK Towerâ€¦'; $rtkSel.appendChild(add);
        if(selectedIdOrName){
          const id = towers.find(t=>t.id===selectedIdOrName || t.name===selectedIdOrName)?.id || '';
          $rtkSel.value=id;
        } else $rtkSel.value='';
      } else {
        $rtkSel.style.display='none';
        $rtkSearchWrap.style.display='flex';
        $rtkList.innerHTML=towers.map(t=>`<option value="${t.name}">`).join('');
        $rtkSearch.value = selectedIdOrName && towers.find(t=>t.id===selectedIdOrName)?.name || '';
      }
    }
    $rtkSel.addEventListener('change', ()=>{
      if($rtkSel.value!==ADD_VALUE) return;
      openRtkModal();
    });
    $rtkAddBtn.addEventListener('click', openRtkModal);

    function openRtkModal(){
      rtkForm.reset();
      rtkBackdrop.style.display='flex';
      setTimeout(()=>rtkName.focus(), 0);
    }
    function closeRtkModal(){ rtkBackdrop.style.display='none'; }

    // RTK inputs: enforce formats
    rtkNet.addEventListener('input', ()=>{
      rtkNet.value = rtkNet.value.replace(/\D/g,'').slice(0,4);
    });
    rtkFreq.addEventListener('keydown',(e)=>{
      const bad=['e','E','+','-']; if(bad.includes(e.key)) return e.preventDefault();
      if(['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Enter'].includes(e.key)) return;
      if(e.key==='.' && rtkFreq.value.includes('.')) return e.preventDefault();
      if(!/^\d$/.test(e.key) && e.key!=='.') e.preventDefault();
    });
    rtkFreq.addEventListener('input',()=>{
      let v=rtkFreq.value.replace(/[^0-9.]/g,'');
      const i=v.indexOf('.');
      if(i!==-1){ v=v.slice(0,i+1)+v.slice(i+1).replace(/\./g,''); v=v.replace(/^(\d+\.\d{0,5}).*$/,'$1'); }
      rtkFreq.value=v;
    });

    $('#rtkCancel').addEventListener('click', closeRtkModal);
    rtkBackdrop.addEventListener('click', (e)=>{ if(e.target===rtkBackdrop) closeRtkModal(); });

    rtkForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const rec={
        name: rtkName.value,
        networkId: rtkNet.value,
        freq: rtkFreq.value
      };
      if(!rec.name.trim()){ alert('Tower name is required.'); rtkName.focus(); return; }
      if(!validNetId(rec.networkId)){ alert('Network ID must be exactly 4 digits.'); rtkNet.focus(); return; }
      if(!validFreq(rec.freq)){ alert('Frequency must be digits with optional decimal (up to 5 places).'); rtkFreq.focus(); return; }

      const id = upsertTower(rec);
      closeRtkModal();

      // reflect into control
      const towers=listTowers();
      const t=towers.find(x=>x.id===id);
      if($rtkSel.style.display==='block'){
        renderRtkControl(id);
      } else {
        $rtkSearch.value = t?.name || '';
        renderRtkControl(id);
      }
    });

    /* ---------- Saved list & quick view ---------- */
    function renderSaved(){
      const q=($('#searchInput').value||'').toLowerCase().trim();
      const showA=$('#toggleShowArchived').checked;
      const farmsById=Object.fromEntries(listFarms().map(f=>[f.id,f]));
      const towersById=Object.fromEntries(listTowers().map(t=>[t.id,t]));

      const rows=load(FIELD_KEY)
        .filter(x=>showA?true:!x.archived)
        .filter(x=>!q || x.name.toLowerCase().includes(q))
        .sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

      $saved.innerHTML = rows.length ? rows.map(r=>{
        const towerTxt = r.rtkTowerId ? (towersById[r.rtkTowerId]?.name || 'â€”') : 'â€”';
        return `<li>
          <button type="button" class="btn-secondary" data-id="${r.id}"
                  style="width:100%; text-align:left; display:block; margin:8px 0;">
            <strong>${r.name}</strong>
            â€¢ ${Number(r.acres||0).toFixed(r.acres%1?2:0)} ac
            ${r.farmId?`â€¢ ${farmsById[r.farmId]?.name || 'â€”'}`:'â€¢ Unassigned'}
            ${r.county?`â€¢ ${r.county}`:''}
            â€¢ RTK: ${towerTxt}
            ${r.archived?'<em style="opacity:.7">â€¢ Archived</em>':''}
          </button>
        </li>`;
      }).join('') : '<li class="muted">No fields yet.</li>';

      $saved.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', ()=> openForEdit(b.getAttribute('data-id')));
      });
    }

    function openForEdit(id){
      const f=getField(id); if(!f) return;
      $id.value=f.id;
      $name.value=f.name;
      $acres.value=String(f.acres ?? '');
      renderFarmControl(f.farmId || '');
      renderCountyControl(f.county || '');
      renderRtkControl(f.rtkTowerId || '');
      window.scrollTo({top:0, behavior:'smooth'}); $name.focus();
    }

    /* ---------- Form actions ---------- */
    $('#field-form').addEventListener('submit',(e)=>{
      e.preventDefault();

      const name=titleCase(($name.value||'').trim());
      const acresRaw=($acres.value||'').trim();
      const acres = acresRaw ? Number(Number(acresRaw).toFixed(2)) : NaN;

      // farm selection
      let farmId=null;
      if($farmSel.style.display==='block'){
        farmId = ($farmSel.value && $farmSel.value!==ADD_VALUE) ? $farmSel.value : null;
      } else {
        const nm = ($farmSearch.value||'').trim();
        if(nm) farmId = upsertFarmByName(nm);
      }

      // county (optional)
      let county='';
      if($countySel.style.display==='block'){
        county = ($countySel.value && $countySel.value!==ADD_VALUE) ? $countySel.value : '';
      } else {
        county = $countySearch.value ? titleCase($countySearch.value) : '';
        if(county) addCountyRaw(county);
      }

      // RTK tower (REQUIRED)
      let rtkTowerId=null, rtkNameSel='';
      if($rtkSel.style.display==='block'){
        if($rtkSel.value===ADD_VALUE){ openRtkModal(); return; }
        rtkTowerId = $rtkSel.value || null;
      } else {
        rtkNameSel = ($rtkSearch.value||'').trim();
        if(rtkNameSel){
          // allow selecting by name if tower exists
          const t=listTowers().find(x=>x.name.toLowerCase()===rtkNameSel.toLowerCase());
          rtkTowerId = t?.id || null;
        }
      }
      if(!rtkTowerId){
        alert('RTK Tower location is required. Please select or add one.');
        ($rtkSel.style.display==='block' ? $rtkSel : $rtkSearch).focus();
        return;
      }

      if(!name){ alert('Field name is required.'); $name.focus(); return; }
      if(!acresRaw || isNaN(acres)){ alert('Enter tillable acres (up to 2 decimals).'); $acres.focus(); return; }

      const id=$id.value || name.toLowerCase();
      const prev=getField(id);
      upsertField({
        id, name, acres, farmId, county: county||null,
        rtkTowerId,
        archived: prev ? !!prev.archived : false,
        createdAt: prev?.createdAt || Date.now(),
        updatedAt: Date.now()
      });

      $('#field-form').reset(); $id.value='';
      renderFarmControl(); renderCountyControl(); renderRtkControl();
      renderSaved();
      $('#savedCard').scrollIntoView({behavior:'smooth', block:'start'});
    });

    $('#clearBtn').addEventListener('click', ()=>{
      $('#field-form').reset(); $id.value='';
      renderFarmControl(); renderCountyControl(); renderRtkControl();
      $name.focus();
    });

    $('#searchInput').addEventListener('input', renderSaved);
    $('#toggleShowArchived').addEventListener('change', renderSaved);

    // Quick View
    $('#quickViewBtn').addEventListener('click', ()=>{
      const farmsById=Object.fromEntries(listFarms().map(f=>[f.id,f]));
      const towersById=Object.fromEntries(listTowers().map(t=>[t.id,t]));
      const list=load(FIELD_KEY).sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
      const L=$('#qvList'), B=$('#qvBackdrop');
      L.innerHTML = list.length ? list.map(r=>`
        <li>
          <button type="button" class="btn-secondary" data-id="${r.id}"
                  style="width:100%; text-align:left; display:block; margin:8px 0;">
            <strong>${r.name}</strong> â€¢ ${Number(r.acres||0).toFixed(r.acres%1?2:0)} ac
            â€¢ ${r.farmId ? (farmsById[r.farmId]?.name || 'â€”') : 'Unassigned'}
            ${r.county?`â€¢ ${r.county}`:''}
            â€¢ RTK: ${r.rtkTowerId ? (towersById[r.rtkTowerId]?.name || 'â€”') : 'â€”'}
          </button>
        </li>`).join('') : '<li>No fields.</li>';
      B.style.display='flex';
      L.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', ()=>{ B.style.display='none'; openForEdit(b.getAttribute('data-id')); });
      });
      $('#qvClose').addEventListener('click', ()=> B.style.display='none', {once:true});
      B.addEventListener('click', (e)=>{ if(e.target===B) B.style.display='none'; }, {once:true});
    });

    /* ---------- Import (CSV) ---------- */
    const impB=$('#impBackdrop');
    const impFile=$('#impFile'); const step1=$('#impStep1'); const step2=$('#impStep2'); const step3=$('#impStep3');
    const mapName=$('#mapName'), mapAcres=$('#mapAcres'), mapFarm=$('#mapFarm'), mapCounty=$('#mapCounty');
    const impNext=$('#impNext'), impBack=$('#impBack'), impCommit=$('#impCommit');

    let csvRows=[]; let csvHeaders=[];

    function openImport(){ impB.style.display='flex'; resetImport(); }
    function closeImport(){ impB.style.display='none'; }
    function resetImport(){
      step1.style.display='block'; step2.style.display='none'; step3.style.display='none';
      impBack.style.display='none'; impCommit.style.display='none'; impNext.style.display='inline-block';
      impNext.disabled=true;
      impFile.value='';
      $('#impPreview').innerHTML='';
      mapName.innerHTML=mapAcres.innerHTML=mapFarm.innerHTML=mapCounty.innerHTML='';
    }

    function parseCSV(text){
      const rows=[]; let i=0, field='', row=[], inQ=false;
      while(i<text.length){
        const c=text[i];
        if(inQ){
          if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
          if(c==='"'){ inQ=false; i++; continue; }
          field+=c; i++; continue;
        }
        if(c==='"'){ inQ=true; i++; continue; }
        if(c===','){ row.push(field); field=''; i++; continue; }
        if(c==='\n' || c==='\r'){
          if(c==='\r' && text[i+1]==='\n') i++;
          row.push(field); rows.push(row); field=''; row=[]; i++; continue;
        }
        field+=c; i++;
      }
      if(field.length || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function autoMap(headers){
      const H=headers.map(h=>h.trim().toLowerCase());
      function idx(...names){ for(const n of names){ const i=H.indexOf(n); if(i>=0) return i; } return -1; }
      return {
        name:  idx('field','field name','name'),
        acres: idx('acres','tillable acres','tillable'),
        farm:  idx('farm','farm name'),
        county:idx('county')
      };
    }

    function fillMappingSelect(sel, headers, preIdx){
      sel.innerHTML = headers.map((h,i)=>`<option value="${i}">${h}</option>`).join('')
        + `<option value="-1">â€” (None)</option>`;
      sel.value = String(preIdx>=0 ? preIdx : -1);
    }

    function renderPreview(){
      const pi = {
        name: Number(mapName.value),
        acres: Number(mapAcres.value),
        farm: Number(mapFarm.value),
        county: Number(mapCounty.value)
      };
      const ok = (pi.name>=0 && pi.acres>=0);
      impNext.style.display='none';
      impBack.style.display='inline-block';
      impCommit.style.display='inline-block';
      impCommit.disabled = !ok;

      const head = `<table class="tbl"><thead><tr>
        <th>Field</th><th>Acres</th><th>Farm</th><th>County</th><th>Status</th></tr></thead><tbody>`;
      let body = '';
      let create=0, update=0, skip=0;

      csvRows.slice(0,200).forEach((r)=>{
        const nm = pi.name>=0 ? r[pi.name] : '';
        const ac = pi.acres>=0 ? r[pi.acres] : '';
        const fm = pi.farm>=0 ? r[pi.farm] : '';
        const cy = pi.county>=0 ? r[pi.county] : '';
        const name=titleCase(String(nm||'').trim());
        const acres = String(ac||'').trim();
        const farm = String(fm||'').trim();
        const county = String(cy||'').trim();

        let status='OK';
        if(!name || !acres) { status='Missing required'; skip++; }
        else {
          const ex = getField(name.toLowerCase());
          status = ex ? 'Will Update' : 'Will Create';
          ex ? update++ : create++;
        }
        body += `<tr>
          <td>${name||'â€”'}</td>
          <td>${acres||'â€”'}</td>
          <td>${farm||'â€”'}</td>
          <td>${county||'â€”'}</td>
          <td class="muted-sm">${status}</td>
        </tr>`;
      });

      $('#impPreview').innerHTML = head + body + '</tbody></table>' +
        `<div class="muted-sm" style="margin-top:8px;">Previewing first ${Math.min(200,csvRows.length)} of ${csvRows.length} rows â€¢ Create ${create}, Update ${update}, Skip ${skip}</div>`;
    }

    function commitImport(){
      const pi = {
        name: Number(mapName.value),
        acres: Number(mapAcres.value),
        farm: Number(mapFarm.value),
        county: Number(mapCounty.value)
      };
      if(!(pi.name>=0 && pi.acres>=0)) return;

      let created=0, updated=0, errors=0;
      const list=load(FIELD_KEY);

      csvRows.forEach(r=>{
        const nm = titleCase(String(r[pi.name]||'').trim());
        const acRaw = String(r[pi.acres]||'').trim();
        if(!nm || !acRaw) return;

        const acres = Number(Number(acRaw).toFixed(2));
        if(isNaN(acres)) { errors++; return; }

        // Farm (optional)
        let farmId=null;
        if(pi.farm>=0){
          const fName = titleCase(String(r[pi.farm]||'').trim());
          if(fName) farmId = upsertFarmByName(fName);
        }

        // County (optional)
        let county=null;
        if(pi.county>=0){
          const cy = titleCase(String(r[pi.county]||'').trim());
          if(cy){ addCountyRaw(cy); county=cy; }
        }

        const id = nm.toLowerCase();
        const i=list.findIndex(x=>x.id===id);
        if(i>=0){
          list[i] = { ...list[i], name:nm, acres, farmId, county: county || null, updatedAt:Date.now() };
          updated++;
        } else {
          list.push({ id, name:nm, acres, farmId, county: county || null, archived:false, createdAt:Date.now(), updatedAt:Date.now() });
          created++;
        }
      });

      save(FIELD_KEY, list);
      closeImport();
      renderSaved();
      alert(`Import complete.\nCreated: ${created}\nUpdated: ${updated}\nErrors: ${errors}`);
    }

    // Import wiring
    $('#importBtn').addEventListener('click', ()=>{ const B=$('#impBackdrop'); B.style.display='flex'; resetImport(); });
    $('#impCancel').addEventListener('click', ()=> $('#impBackdrop').style.display='none');
    $('#impBackdrop').addEventListener('click', (e)=>{ if(e.target===e.currentTarget) $('#impBackdrop').style.display='none'; });

    const impFile=$('#impFile'); const step1=$('#impStep1'); const step2=$('#impStep2'); const step3=$('#impStep3');
    const mapName=$('#mapName'), mapAcres=$('#mapAcres'), mapFarm=$('#mapFarm'), mapCounty=$('#mapCounty');
    const impNext=$('#impNext'), impBack=$('#impBack'), impCommit=$('#impCommit');
    let csvRows=[], csvHeaders=[];

    impFile.addEventListener('change', async ()=>{
      const f=impFile.files?.[0]; if(!f){ impNext.disabled=true; return; }
      const text = await f.text();
      const rows = (function parseCSV(text){
        const rows=[]; let i=0, field='', row=[], inQ=false;
        while(i<text.length){
          const c=text[i];
          if(inQ){
            if(c==='"' && text[i+1]==='"'){ field+='"'; i+=2; continue; }
            if(c==='"'){ inQ=false; i++; continue; }
            field+=c; i++; continue;
          }
          if(c==='"'){ inQ=true; i++; continue; }
          if(c===','){ row.push(field); field=''; i++; continue; }
          if(c==='\n' || c==='\r'){
            if(c==='\r' && text[i+1]==='\n') i++;
            row.push(field); rows.push(row); field=''; row=[]; i++; continue;
          }
          field+=c; i++;
        }
        if(field.length || row.length) { row.push(field); rows.push(row); }
        return rows;
      })(text);

      if(!rows.length){ alert('Empty file'); return; }
      csvHeaders = rows.shift().map(h=>String(h||'').trim());
      csvRows = rows.filter(r=>r.some(c=>String(c||'').trim().length));
      // move to mapping
      step1.style.display='none'; step2.style.display='block'; step3.style.display='none';
      impNext.disabled=false;

      const H=csvHeaders.map(h=>h.trim().toLowerCase());
      function idx(...names){ for(const n of names){ const i=H.indexOf(n); if(i>=0) return i; } return -1; }
      const guess = {
        name:  idx('field','field name','name'),
        acres: idx('acres','tillable acres','tillable'),
        farm:  idx('farm','farm name'),
        county:idx('county')
      };

      const fill=(sel, idx)=>{ sel.innerHTML = csvHeaders.map((h,i)=>`<option value="${i}">${h}</option>`).join('') + `<option value="-1">â€” (None)</option>`; sel.value = String(idx>=0 ? idx : -1); };
      fill(mapName, guess.name); fill(mapAcres, guess.acres); fill(mapFarm, guess.farm); fill(mapCounty, guess.county);
    });

    $('#impNext').addEventListener('click', ()=>{
      if(step2.style.display==='block'){
        step2.style.display='none'; step3.style.display='block';
        (function renderPreview(){
          const pi = {
            name: Number(mapName.value),
            acres: Number(mapAcres.value),
            farm: Number(mapFarm.value),
            county: Number(mapCounty.value)
          };
          const ok = (pi.name>=0 && pi.acres>=0);
          impNext.style.display='none';
          impBack.style.display='inline-block';
          impCommit.style.display='inline-block';
          impCommit.disabled = !ok;

          const head = `<table class="tbl"><thead><tr>
            <th>Field</th><th>Acres</th><th>Farm</th><th>County</th><th>Status</th></tr></thead><tbody>`;
          let body = '';
          let create=0, update=0, skip=0;

          csvRows.slice(0,200).forEach((r)=>{
            const nm = pi.name>=0 ? r[pi.name] : '';
            const ac = pi.acres>=0 ? r[pi.acres] : '';
            const fm = pi.farm>=0 ? r[pi.farm] : '';
            const cy = pi.county>=0 ? r[pi.county] : '';
            const name=titleCase(String(nm||'').trim());
            const acres = String(ac||'').trim();
            const farm = String(fm||'').trim();
            const county = String(cy||'').trim();

            let status='OK';
            if(!name || !acres) { status='Missing required'; skip++; }
            else {
              const ex = getField(name.toLowerCase());
              status = ex ? 'Will Update' : 'Will Create';
              ex ? update++ : create++;
            }
            body += `<tr>
              <td>${name||'â€”'}</td>
              <td>${acres||'â€”'}</td>
              <td>${farm||'â€”'}</td>
              <td>${county||'â€”'}</td>
              <td class="muted-sm">${status}</td>
            </tr>`;
          });

          $('#impPreview').innerHTML = head + body + '</tbody></table>' +
            `<div class="muted-sm" style="margin-top:8px;">Previewing first ${Math.min(200,csvRows.length)} of ${csvRows.length} rows â€¢ Create ${create}, Update ${update}, Skip ${skip}</div>`;
        })();
      }
    });
    $('#impBack').addEventListener('click', ()=>{
      step3.style.display='none'; step2.style.display='block';
      impCommit.style.display='none'; impNext.style.display='inline-block';
    });
    $('#impCommit').addEventListener('click', commitImport);

    // Initial render
    renderFarmControl(); renderCountyControl(); renderRtkControl(); renderSaved();

    // Quick View wiring
    $('#quickViewBtn').addEventListener('click', ()=>{
      const farmsById=Object.fromEntries(listFarms().map(f=>[f.id,f]));
      const towersById=Object.fromEntries(listTowers().map(t=>[t.id,t]));
      const list=load(FIELD_KEY).sort((a,b)=>a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
      const L=$('#qvList'), B=$('#qvBackdrop');
      L.innerHTML = list.length ? list.map(r=>`
        <li>
          <button type="button" class="btn-secondary" data-id="${r.id}"
                  style="width:100%; text-align:left; display:block; margin:8px 0;">
            <strong>${r.name}</strong> â€¢ ${Number(r.acres||0).toFixed(r.acres%1?2:0)} ac
            â€¢ ${r.farmId ? (farmsById[r.farmId]?.name || 'â€”') : 'Unassigned'}
            ${r.county?`â€¢ ${r.county}`:''}
            â€¢ RTK: ${r.rtkTowerId ? (towersById[r.rtkTowerId]?.name || 'â€”') : 'â€”'}
          </button>
        </li>`).join('') : '<li>No fields.</li>';
      B.style.display='flex';
      L.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click', ()=>{ B.style.display='none'; openForEdit(b.getAttribute('data-id')); });
      });
      $('#qvClose').addEventListener('click', ()=> B.style.display='none', {once:true});
      B.addEventListener('click', (e)=>{ if(e.target===B) B.style.display='none'; }, {once:true});
    });

    // Footer version/date hook if your core sets them:
    if(window.setBreadcrumbs){
      window.setBreadcrumbs([
        {label:'Home', href:'index.html'},
        {label:'Setup / Settings', href:'settings.html'},
        {label:'Fields'}
      ]);
    }
  })();
  </script>
</body>
</html>