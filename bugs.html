<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Bugs / Issues ‚Äî Dowson Farms</title>

  <!-- Styles / App -->
  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/maskable-512.png" />

  <style>
    .content { padding-bottom: calc(var(--footer-h) + 120px); }

    /* Two equal columns, tighter spacing */
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 12px;
      align-items: start;
    }
    @media (max-width: 720px){
      .row { grid-template-columns: 1fr; }
    }

    .field { margin: 8px 0; }
    .field label { display:block; font-weight:700; color: var(--brand-green); margin-bottom:6px; }

    select, input[type="text"], input[type="date"], textarea{
      width:100%; padding:10px; border:1px solid var(--tile-border);
      border-radius:8px; background: var(--tile-bg); color: var(--ink);
      font-size:16px; box-sizing:border-box;
    }
    textarea{ min-height:110px; }

    .field input:focus, .field select:focus, .field textarea:focus{
      outline:none; border-color: var(--tile-border); box-shadow: 0 0 0 3px rgba(45,106,49,.30);
    }

    .muted { color:#666; font-size:.9rem; }

    /* Form actions */
    .form-actions{
      margin-top: 12px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
    }
    .form-actions .center { justify-self: center; }
    .form-actions .right  { justify-self: end; }

    .btn-solid{
      background: var(--brand-green); color:#fff; border:0; border-radius:12px;
      padding:9px 14px; cursor:pointer; font: 600 .95rem 'Playfair Display', serif;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }
    .btn-solid:hover{ background:#154a18; }
    .btn-outline{
      background: var(--tile-bg); color: var(--brand-green);
      border:2px solid var(--brand-green); border-radius:10px;
      padding:6px 10px; cursor:pointer; font: 600 .9rem 'Playfair Display', serif;
    }
    :root[data-theme="dark"] .btn-outline,
    :root[data-theme="auto"] .btn-outline{ color: var(--ink); border-color: var(--tile-border); }
    .btn-outline:hover{ background:#fefefe; }

    /* Quick View button */
    .quick-fab{
      position: fixed; right: 10px;
      bottom: calc(env(safe-area-inset-bottom, 0px) + var(--footer-h) + 8px);
      display: inline-flex; align-items: center; gap: 6px;
      padding: 6px 10px; background: var(--tile-bg);
      color: var(--brand-green); border: 2px solid var(--brand-green);
      border-radius: 12px; font: 600 .9rem 'Playfair Display', serif;
      box-shadow: 0 6px 16px rgba(0,0,0,.12); cursor: pointer;
      z-index: calc(var(--z-footer) + 10);
    }
    :root[data-theme="dark"] .quick-fab,
    :root[data-theme="auto"] .quick-fab{ color: var(--ink); border-color: var(--tile-border); }
    .quick-fab:hover, .quick-fab:focus-visible { background:#fefefe; outline: none; }

    /* Quick View modal */
    .qv-backdrop{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,.38); z-index: 2000; }
    .qv-modal{ width: min(560px, 92vw); background: var(--tile-bg); border: 2px solid var(--tile-border, var(--brand-green)); border-radius: 14px; box-shadow: 0 18px 40px rgba(0,0,0,.25); padding: 14px; }
    .qv-modal h2{ margin: 0 0 8px; font-size: 1.1rem; color: var(--brand-green); }
    .qv-list{ margin: 8px 0 0; padding: 0; list-style: none; }
    .qv-item{ border: 1px solid var(--tile-border, var(--brand-green)); border-radius: 10px; padding: 8px 10px; margin: 8px 0; background: var(--tile-bg); color: var(--ink); }
    .qv-actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  </style>

  <!-- Apply saved theme ASAP before paint -->
  <script>
    (function bootTheme(){
      try {
        const saved = localStorage.getItem('df_theme') || 'auto';
        document.documentElement.setAttribute('data-theme', saved);
      } catch(_) {}
    })();
  </script>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right">
      <span id="clock" class="clock">--:--</span>
    </div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">‚Ä∫</li>
      <li><a href="feedback.html">Feedback</a></li>
      <li class="sep">‚Ä∫</li>
      <li><span>Bugs / Issues</span></li>
    </ol>
  </nav>

  <!-- Content -->
  <main class="content" data-has-form>
    <h1>üõ†Ô∏è Bugs / Issues</h1>

    <form id="bug-form" novalidate>
      <div class="row">
        <div class="field">
          <label for="submittedBy">Submitted by</label>
          <select id="submittedBy" required></select>
          <small id="whoHint" class="muted"></small>
        </div>
        <div class="field">
          <label for="submittedDate">Date submitted</label>
          <input id="submittedDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="menuSel">Menu</label>
          <select id="menuSel" required></select>
        </div>
        <div class="field">
          <label for="submenuSel">Submenu</label>
          <select id="submenuSel" required></select>
        </div>
      </div>

      <div class="field">
        <label for="message">Message</label>
        <textarea id="message" required placeholder="Describe the bug or issue‚Ä¶"></textarea>
      </div>

      <div class="form-actions">
        <div></div>
        <div class="center">
          <button class="btn-solid" type="submit">Submit Issue</button>
        </div>
        <div class="right">
          <button class="btn-outline" type="reset">Clear</button>
        </div>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View button -->
  <button type="button" class="quick-fab" id="quickViewBtn">Quick View</button>

  <!-- Quick View modal -->
  <div class="qv-backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle">
    <div class="qv-modal">
      <h2 id="qvTitle">Open Issues</h2>
      <ul class="qv-list" id="qvList"></ul>
      <div class="qv-actions">
        <button class="btn-outline" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function BugsPage(){
      const getCurrentUser = (window.getCurrentUser) ? window.getCurrentUser : () => localStorage.getItem('df_current_user') || '';

      const EMPLOYEES = JSON.parse(localStorage.getItem('df_people') || '[]');
      if (!EMPLOYEES.length) {
        localStorage.setItem('df_people', JSON.stringify([
          {name:'John Doe'}, {name:'Jane Smith'}, {name:'Sam Operator'}, {name:'Vendor Co.'}
        ]));
      }

      const DEFAULT_MENUS = {
        "Home": ["‚Äî"],
        "Crop Production": ["Planting","Spraying","Harvest"],
        "Grain Tracking": ["Bins","Tickets","Contracts"],
        "Equipment": ["Maintenance","Repairs","Assignments"],
        "Calculators": ["Seed Rate","Fertilizer","ROI"],
        "Reports": ["Crops","Equipment","Financial"],
        "Team / Partners": ["Employees","Vendors"],
        "Feedback": ["Ideas","Bugs / Issues"],
        "Setup / Settings": ["Farms","Fields","Theme","Account Roles","Crop Types"]
      };
      const MENUS = JSON.parse(localStorage.getItem('df_menus') || 'null') || DEFAULT_MENUS;

      const bySel = document.getElementById('submittedBy');
      const dateEl = document.getElementById('submittedDate');
      const whoHint = document.getElementById('whoHint');
      const menuSel = document.getElementById('menuSel');
      const submenuSel = document.getElementById('submenuSel');
      const msgEl = document.getElementById('message');
      const form = document.getElementById('bug-form');

      const qvBtn = document.getElementById('quickViewBtn');
      const qvBackdrop = document.getElementById('qvBackdrop');
      const qvList = document.getElementById('qvList');
      const qvClose = document.getElementById('qvClose');

      function renderPeople(){
        const people = JSON.parse(localStorage.getItem('df_people'));
        const you = getCurrentUser();
        bySel.innerHTML = '';
        people.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name + (you && you === p.name ? ' (You)' : '');
          bySel.appendChild(opt);
        });
        if (you) {
          const found = [...bySel.options].find(o => o.value === you);
          if (found) bySel.value = you;
        }
        whoHint.textContent = bySel.value ? '' : 'Tip: set df_current_user in localStorage to auto-select you.';
      }

      function renderMenus(){
        menuSel.innerHTML = '';
        Object.keys(MENUS).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          menuSel.appendChild(opt);
        });
        renderSubmenus(menuSel.value);
      }
      function renderSubmenus(menu){
        submenuSel.innerHTML = '';
        (MENUS[menu] || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          submenuSel.appendChild(opt);
        });
      }

      function todayCT(){
        const now = new Date();
        const parts = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
        const y = parts.find(p=>p.type==='year').value;
        const m = parts.find(p=>p.type==='month').value;
        const d = parts.find(p=>p.type==='day').value;
        return `${y}-${m}-${d}`;
      }

      function saveIssue(data){
        const list = JSON.parse(localStorage.getItem('df_bugs') || '[]');
        list.push(data);
        localStorage.setItem('df_bugs', JSON.stringify(list));
      }

      function openQuickView(){
        qvList.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('df_bugs') || '[]')
          .filter(i => i.status !== 'closed' && i.status !== 'archived');
        if (!list.length) {
          const li = document.createElement('li');
          li.className = 'qv-item';
          li.textContent = 'No open issues.';
          qvList.appendChild(li);
        } else {
          list.forEach(i => {
            const li = document.createElement('li');
            li.className = 'qv-item';
            li.innerHTML = `<strong>${i.menu} ‚Ä∫ ${i.submenu}</strong><br>
                            <em>${i.submittedBy}</em> ‚Ä¢ ${i.date}<br>
                            ${i.message}`;
            qvList.appendChild(li);
          });
        }
        qvBackdrop.style.display = 'flex';
      }
      function closeQuickView(){ qvBackdrop.style.display = 'none'; }

      renderPeople();
      dateEl.value = todayCT();
      renderMenus();

      menuSel.addEventListener('change', () => renderSubmenus(menuSel.value));
      qvBtn.addEventListener('click', openQuickView);
      qvClose.addEventListener('click', closeQuickView);
      qvBackdrop.addEventListener('click', (e)=>{ if(e.target===qvBackdrop) closeQuickView(); });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!bySel.value || !dateEl.value || !menuSel.value || !submenuSel.value || !msgEl.value.trim()) {
          alert('Please complete all required fields.');
          return;
        }
        const record = {
          submittedBy: bySel.value.replace(/\s+\(You\)$/,''),
          date: dateEl.value,
          menu: menuSel.value,
          submenu: submenuSel.value,
          message: msgEl.value.trim(),
          status: 'open',
          ts: Date.now()
        };
        saveIssue(record);
        form.reset();
        renderPeople();
        dateEl.value = todayCT();
        renderMenus();
        alert('Issue submitted!');
      });

      window.setBreadcrumbs?.([
        {label:'Home', href:'index.html'},
        {label:'Feedback', href:'feedback.html'},
        {label:'Bugs / Issues'}
      ]);
    })();
  </script>

  <!-- Service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>