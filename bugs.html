<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Bugs / Issues ‚Äî Dowson Farms</title>

  <!-- Styles / App -->
  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />

  <!-- iOS PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/maskable-512.png" />
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right">
      <span id="clock" class="clock">--:--</span>
    </div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="index.html">Home</a></li>
      <li class="sep">‚Ä∫</li>
      <li><a href="feedback.html">Feedback</a></li>
      <li class="sep">‚Ä∫</li>
      <li><span>Bugs / Issues</span></li>
    </ol>
  </nav>

  <!-- Content -->
  <main class="content" data-has-form>
    <h1>üõ†Ô∏è Bugs / Issues</h1>

    <form id="bug-form" novalidate>
      <div class="row">
        <div class="field">
          <label for="submittedBy">Submitted by</label>
          <select id="submittedBy" required></select>
          <small id="whoHint" class="field-hint" style="color:#666;"></small>
        </div>
        <div class="field">
          <label for="submittedDate">Date submitted</label>
          <input id="submittedDate" type="date" required />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="menuSel">Menu</label>
          <select id="menuSel" required></select>
        </div>
        <div class="field">
          <label for="submenuSel">Submenu</label>
          <select id="submenuSel" required></select>
        </div>
      </div>

      <div class="field">
        <label for="message">Message</label>
        <textarea id="message" required placeholder="Describe the bug or issue‚Ä¶"></textarea>
      </div>

      <!-- Actions -->
      <div class="form-actions">
        <div></div>
        <button class="btn-primary" type="submit">Submit Issue</button>
        <div style="display:flex; gap:8px;">
          <button class="btn-outline" type="reset" id="clearBtn">Clear</button>
          <button type="button" class="btn-secondary" id="quickViewBtn">Quick View</button>
        </div>
      </div>
    </form>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View modal -->
  <div class="auth-modal__backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(560px,92vw);">
      <h2 id="qvTitle">Open Issues</h2>
      <ul class="qv-list" id="qvList" style="list-style:none; padding:0; margin:8px 0 0;"></ul>
      <div class="modal-actions">
        <button class="btn-secondary" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    (function BugsPage(){
      const getCurrentUser = (window.getCurrentUser) ? window.getCurrentUser : () => localStorage.getItem('df_current_user') || 'Admin';

      if (!localStorage.getItem('df_people')) {
        localStorage.setItem('df_people', JSON.stringify([
          {name:'John Doe'}, {name:'Jane Smith'}, {name:'Sam Operator'}, {name:'Vendor Co.'}
        ]));
      }

      const DEFAULT_MENUS = {
        "Home": ["‚Äî"],
        "Crop Production": ["Planting","Spraying","Harvest"],
        "Grain Tracking": ["Bins","Tickets","Contracts"],
        "Equipment": ["Maintenance","Repairs","Assignments"],
        "Calculators": ["Seed Rate","Fertilizer","ROI"],
        "Reports": ["Crops","Equipment","Financial"],
        "Team / Partners": ["Employees","Vendors"],
        "Feedback": ["Ideas","Bugs / Issues"],
        "Setup / Settings": ["Farms","Fields","Theme","Account Roles","Crop Types"]
      };
      const ADD_VALUE = "__ADD__";
      const MENUS = JSON.parse(localStorage.getItem('df_menus') || 'null') || DEFAULT_MENUS;

      const bySel = document.getElementById('submittedBy');
      const dateEl = document.getElementById('submittedDate');
      const whoHint = document.getElementById('whoHint');
      const menuSel = document.getElementById('menuSel');
      const submenuSel = document.getElementById('submenuSel');
      const msgEl = document.getElementById('message');
      const form = document.getElementById('bug-form');

      const qvBtn = document.getElementById('quickViewBtn');
      const qvBackdrop = document.getElementById('qvBackdrop');
      const qvList = document.getElementById('qvList');
      const qvClose = document.getElementById('qvClose');

      function todayCT(){
        const now = new Date();
        const parts = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/Chicago', year:'numeric', month:'2-digit', day:'2-digit' }).formatToParts(now);
        const y = parts.find(p=>p.type==='year').value;
        const m = parts.find(p=>p.type==='month').value;
        const d = parts.find(p=>p.type==='day').value;
        return `${y}-${m}-${d}`;
      }

      function renderPeople(){
        const people = JSON.parse(localStorage.getItem('df_people'));
        const you = getCurrentUser();
        bySel.innerHTML = '';
        people.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.name;
          opt.textContent = p.name + (you && you === p.name ? ' (You)' : '');
          bySel.appendChild(opt);
        });
        if (you) {
          const found = [...bySel.options].find(o => o.value === you);
          if (found) bySel.value = you;
        }
        whoHint.textContent = bySel.value ? '' : 'Tip: set df_current_user in localStorage to auto-select you.';
      }

      function addAddOption(selectEl, label){
        const opt = document.createElement('option');
        opt.value = "__ADD__";
        opt.textContent = label;
        opt.setAttribute('data-add','1');
        selectEl.appendChild(opt);
      }

      function renderMenus(selectFirst = true){
        menuSel.innerHTML = '';
        Object.keys(MENUS).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          menuSel.appendChild(opt);
        });
        addAddOption(menuSel, '‚ûï Add New Menu‚Ä¶');
        if (selectFirst && menuSel.options.length) menuSel.selectedIndex = 0;
        renderSubmenus(menuSel.value, true);
      }

      function renderSubmenus(menu, selectFirst = false){
        submenuSel.innerHTML = '';
        (MENUS[menu] || []).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          submenuSel.appendChild(opt);
        });
        addAddOption(submenuSel, '‚ûï Add New Submenu‚Ä¶');
        if (selectFirst && submenuSel.options.length) submenuSel.selectedIndex = 0;
      }

      function saveMenus(){
        localStorage.setItem('df_menus', JSON.stringify(MENUS));
      }

      function handleMaybeAdd(selectEl, type){
        if (selectEl.value !== "__ADD__") return;
        const currentMenu = menuSel.value;
        const label = (type === 'menu') ? 'New menu name:' : `New submenu for "${currentMenu}":`;
        const raw = prompt(label);
        if (!raw) { renderMenus(false); renderSubmenus(currentMenu,false); return; }
        const name = raw.trim().replace(/^./, c => c.toUpperCase());
        if (!name) return;

        if (type === 'menu') {
          if (!MENUS[name]) MENUS[name] = ['‚Äî'];
          saveMenus();
          renderMenus(false);
          menuSel.value = name;
          renderSubmenus(name, true);
        } else {
          if (!MENUS[currentMenu]) MENUS[currentMenu] = [];
          if (!MENUS[currentMenu].includes(name)) MENUS[currentMenu].push(name);
          saveMenus();
          renderSubmenus(currentMenu, false);
          submenuSel.value = name;
        }
      }

      function saveIssue(data){
        const list = JSON.parse(localStorage.getItem('df_bugs') || '[]');
        list.push(data);
        localStorage.setItem('df_bugs', JSON.stringify(list));
      }

      function openQuickView(){
        qvList.innerHTML = '';
        const list = JSON.parse(localStorage.getItem('df_bugs') || '[]')
          .filter(i => i.status !== 'closed' && i.status !== 'archived')
          .sort((a,b)=>b.ts-a.ts);
        if (!list.length) {
          const li = document.createElement('li');
          li.textContent = 'No open issues.';
          qvList.appendChild(li);
        } else {
          list.forEach(i => {
            const li = document.createElement('li');
            li.style.border='1px solid var(--tile-border)';
            li.style.borderRadius='10px';
            li.style.padding='8px 10px';
            li.style.margin='8px 0';
            li.innerHTML = `<strong>${i.menu} ‚Ä∫ ${i.submenu}</strong><br>
                            <em>${i.submittedBy}</em> ‚Ä¢ ${i.date}<br>
                            ${i.message}`;
            qvList.appendChild(li);
          });
        }
        qvBackdrop.style.display = 'flex';
      }
      function closeQuickView(){ qvBackdrop.style.display = 'none'; }

      // Init
      renderPeople();
      dateEl.value = todayCT();
      renderMenus(true);

      menuSel.addEventListener('change', (e) => {
        if (e.target.value === "__ADD__") { handleMaybeAdd(menuSel, 'menu'); return; }
        renderSubmenus(menuSel.value, true);
      });
      submenuSel.addEventListener('change', () => handleMaybeAdd(submenuSel, 'submenu'));

      qvBtn.addEventListener('click', openQuickView);
      qvClose.addEventListener('click', closeQuickView);
      qvBackdrop.addEventListener('click', (e)=>{ if(e.target===qvBackdrop) closeQuickView(); });

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!bySel.value || !dateEl.value || !menuSel.value || !submenuSel.value || !msgEl.value.trim()) {
          alert('Please complete all required fields.');
          return;
        }
        const record = {
          submittedBy: bySel.value.replace(/\s+\(You\)$/,''),
          date: dateEl.value,
          menu: menuSel.value,
          submenu: submenuSel.value,
          message: msgEl.value.trim(),
          status: 'open',
          ts: Date.now()
        };
        saveIssue(record);
        form.reset();
        renderPeople();
        dateEl.value = todayCT();
        renderMenus(true);
        alert('Issue submitted!');
      });

      window.setBreadcrumbs?.([
        {label:'Home', href:'index.html'},
        {label:'Feedback', href:'feedback.html'},
        {label:'Bugs / Issues'}
      ]);
    })();
  </script>

  <!-- Service worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>