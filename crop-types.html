<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Settings · Crop Types — Dowson Farms</title>

  <!-- exactly what Issues/Bugs pages load -->
  <link rel="stylesheet" href="theme.css" />
  <script defer src="version.js"></script>
  <script defer src="core.js"></script>
</head>
<body class="content">

  <!-- HEADER -->
  <header class="page-head">
    <div class="toolbar">
      <button class="btn ghost" id="btnBack">← Back</button>
      <h1>Crop Types</h1>
    </div>
    <p class="muted">Add and manage crop definitions used in calculations. Unit is fixed to bushels (bu).</p>
  </header>

  <!-- TOP ACTIONS (matches other pages: button + search + toggle) -->
  <div class="toolbar">
    <button class="btn" id="btnQuickView">Quick View</button>
    <input id="cropSearch" class="search" type="search" placeholder="Search crops…" />
    <label class="muted" for="toggleShowArchived">
      <input type="checkbox" id="toggleShowArchived" /> Show archived
    </label>
  </div>

  <!-- FORM (card) -->
  <form id="cropTypeForm" class="card" autocomplete="off">
    <div class="form-row">
      <label for="cropName">Crop name <span class="req">*</span></label>
      <input id="cropName" name="cropName" type="text" required placeholder="e.g., Corn, Soybeans" />
      <small class="help muted">Uses global capitalization rule.</small>
    </div>

    <div class="form-row">
      <label for="testWeight">Standard test weight (lb/bu) <span class="req">*</span></label>
      <input id="testWeight" name="testWeight" type="number" step="0.1" min="0" required placeholder="56 for Corn, 60 for Soybeans" />
    </div>

    <div class="form-row">
      <label for="standardMoisture">Standard moisture (%) <span class="req">*</span></label>
      <input id="standardMoisture" name="standardMoisture" type="number" step="0.1" min="0" max="100" required placeholder="15.5 for Corn, 13 for Soybeans" />
      <small class="help muted">Basis for shrink & other calcs.</small>
    </div>

    <div class="form-row readonly">
      <label>Unit of measure</label>
      <input type="text" value="Bushels (bu)" readonly />
    </div>

    <div class="form-actions">
      <input type="hidden" id="editingId" value="" />
      <button type="submit" class="btn primary" id="saveCropBtn">Save crop</button>
      <button type="button" class="btn ghost" id="resetCropFormBtn">Clear</button>
    </div>
  </form>

  <!-- LIST (card + table) -->
  <div class="card">
    <div class="card-head">
      <h2>Saved Crops</h2>
    </div>
    <div class="table-wrap">
      <table class="table tight" id="cropTypesTable" aria-label="Crop types">
        <thead>
          <tr>
            <th>Name</th>
            <th>Test wt (lb/bu)</th>
            <th>Std moisture (%)</th>
            <th></th>
          </tr>
        </thead>
        <tbody><!-- injected --></tbody>
      </table>
    </div>
  </div>

  <!-- QUICK VIEW (simple dialog) -->
  <dialog id="quickViewModal">
    <article>
      <header class="toolbar">
        <h3>Crop Type Records</h3>
        <button class="btn ghost" id="closeQuick">Close</button>
      </header>
      <div class="table-wrap">
        <table class="table" id="quickViewTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>Test wt</th>
              <th>Moisture</th>
              <th>Status</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody><!-- injected --></tbody>
        </table>
      </div>
    </article>
  </dialog>

  <script>
    // ===== Use the same pattern as Issues/Bugs: tiny inline logic, no custom CSS =====

    // Global-capitalization hook (uses your core if present)
    function applyGlobalCase(str) {
      try {
        if (window.App && App.util && typeof App.util.applyGlobalCase === 'function') {
          return App.util.applyGlobalCase(str);
        }
      } catch (e) {}
      // Fallback: Title Case
      return (str || '').toLowerCase().replace(/\b([a-z])/g, c => c.toUpperCase());
    }
    function slugify(s){return (s||'').toString().trim().toLowerCase().replace(/[\s_]+/g,'-').replace(/[^a-z0-9\-]/g,'').replace(/\-+/g,'-');}
    function nowTS(){return Date.now();}
    function fmtDT(ts){try{const d=new Date(ts);return d.toLocaleString();}catch(_){return ''}}

    // Storage key (localStorage like your other light-weight forms)
    const KEY = 'df.crops';
    function loadAll(){ try { return JSON.parse(localStorage.getItem(KEY)||'[]'); } catch(_) { return []; } }
    function saveAll(list){ localStorage.setItem(KEY, JSON.stringify(list)); }
    function getById(id){ return loadAll().find(x=>x.id===id); }
    function upsert(item){
      const list = loadAll();
      const i = list.findIndex(x=>x.id===item.id);
      if (i>=0) list[i]=item; else list.push(item);
      saveAll(list);
    }
    function removeById(id){ saveAll(loadAll().filter(x=>x.id!==id)); }

    // Elements
    const $form = document.getElementById('cropTypeForm');
    const $name = document.getElementById('cropName');
    const $tw = document.getElementById('testWeight');
    const $mo = document.getElementById('standardMoisture');
    const $editId = document.getElementById('editingId');
    const $tableBody = document.querySelector('#cropTypesTable tbody');
    const $search = document.getElementById('cropSearch');
    const $showArchived = document.getElementById('toggleShowArchived');
    const $modal = document.getElementById('quickViewModal');
    const $quickBody = document.querySelector('#quickViewTable tbody');

    // Back uses your nav helper if available
    document.getElementById('btnBack').addEventListener('click', () => {
      if (window.App && App.nav && typeof App.nav.back === 'function') App.nav.back();
      else history.back();
    });

    // Clear
    document.getElementById('resetCropFormBtn').addEventListener('click', resetForm);

    // Submit (Add / Save)
    $form.addEventListener('submit', (e) => {
      e.preventDefault();
      const raw = $name.value.trim();
      if (!raw) { $name.focus(); return; }

      const pretty = applyGlobalCase(raw);
      const id = $editId.value || slugify(pretty);

      // duplicate guard (case-insensitive), allow same-id edit
      const list = loadAll();
      const dup = list.find(x => x.id !== id && x.name.toLowerCase() === pretty.toLowerCase());
      if (dup) { alert('That crop already exists.'); return; }

      const existing = list.find(x=>x.id===id);
      const item = {
        id,
        name: pretty,
        testWeight: Number($tw.value),
        standardMoisture: Number($mo.value),
        unit: 'bu',
        archived: existing ? !!existing.archived : false,
        createdAt: existing ? existing.createdAt : nowTS(),
        updatedAt: nowTS()
      };
      upsert(item);
      render();
      resetForm();
    });

    // Search + show-archived
    $search.addEventListener('input', render);
    $showArchived.addEventListener('change', render);

    // Quick View
    document.getElementById('btnQuickView').addEventListener('click', () => {
      fillQuickView();
      $modal.showModal();
    });
    document.getElementById('closeQuick').addEventListener('click', () => $modal.close());

    function resetForm(){
      $form.reset();
      $editId.value = '';
      $name.focus();
    }

    function render(){
      const q = ($search.value||'').trim().toLowerCase();
      const showArchived = $showArchived.checked;
      const rows = loadAll()
        .filter(x => showArchived ? true : !x.archived)
        .filter(x => !q || x.name.toLowerCase().includes(q))
        .sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));

      $tableBody.innerHTML = rows.map(r => {
        const status = r.archived ? ' (Archived)' : '';
        return `<tr>
          <td>${r.name}${status ? ' <span class="tag archived">Archived</span>' : ''}</td>
          <td>${(r.testWeight ?? '').toString()}</td>
          <td>${(r.standardMoisture ?? '').toString()}</td>
          <td>
            <button class="btn" data-act="edit" data-id="${r.id}">Edit</button>
            ${r.archived
              ? `<button class="btn" data-act="unarchive" data-id="${r.id}">Unarchive</button>`
              : `<button class="btn" data-act="archive" data-id="${r.id}">Archive</button>`}
            <button class="btn ghost" data-act="delete" data-id="${r.id}">Delete</button>
          </td>
        </tr>`;
      }).join('');

      // bind row actions
      $tableBody.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', onRowAction);
      });
    }

    function onRowAction(e){
      const act = e.currentTarget.getAttribute('data-act');
      const id = e.currentTarget.getAttribute('data-id');
      const item = getById(id);
      if (!item) return;

      if (act === 'edit'){
        $editId.value = item.id;
        $name.value = item.name;
        $tw.value = item.testWeight;
        $mo.value = item.standardMoisture;
        window.scrollTo({ top: 0, behavior: 'smooth' });
        $name.focus();
      }
      if (act === 'archive'){ item.archived = true; item.updatedAt = nowTS(); upsert(item); render(); }
      if (act === 'unarchive'){ item.archived = false; item.updatedAt = nowTS(); upsert(item); render(); }
      if (act === 'delete'){
        if (confirm('Delete this crop permanently?')) { removeById(id); render(); }
      }
    }

    function fillQuickView(){
      const list = loadAll().sort((a,b)=> a.name.localeCompare(b.name, undefined, {sensitivity:'base'}));
      $quickBody.innerHTML = list.map(r=>`
        <tr>
          <td>${r.name}</td>
          <td>${r.testWeight}</td>
          <td>${r.standardMoisture}</td>
          <td>${r.archived ? 'Archived' : 'Active'}</td>
          <td>${fmtDT(r.updatedAt)}</td>
        </tr>
      `).join('');
    }

    // Seed defaults (Corn/Soybeans) only if empty
    (function seed(){
      const list = loadAll();
      if (list.length) { render(); return; }
      const seeds = [
        { name:'Corn', testWeight:56, standardMoisture:15.5 },
        { name:'Soybeans', testWeight:60, standardMoisture:13.0 }
      ].map(s => ({
        id: slugify(applyGlobalCase(s.name)),
        name: applyGlobalCase(s.name),
        testWeight: s.testWeight,
        standardMoisture: s.standardMoisture,
        unit:'bu',
        archived:false,
        createdAt: nowTS(),
        updatedAt: nowTS()
      }));
      saveAll(seeds);
      render();
    })();
  </script>
</body>
</html>