<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dowson Farms</title>
  <base href="./"/>

  <!-- PWA manifest + meta -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1B5E20">

  <!-- iOS app mode -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dowson Farms">
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png">

  <!-- Icons -->
  <link rel="icon" sizes="192x192" href="assets/icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="assets/icons/icon-512.png">

  <!-- Styles -->
  <link rel="stylesheet" href="assets/css/theme.css"/>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="logo">
      <img src="assets/icons/logo.png" alt="Dowson Farms">
    </div>
    <div class="title">Dowson Farms</div>
    <div class="spacer"><span id="df-clock"></span></div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs">
    <button id="hamburger" class="hamburger" aria-label="Open menu">☰</button>
    <ol id="crumbs"><li><span>Home</span></li></ol>
    <button class="logout-btn" id="logout">Logout</button>
  </nav>

  <!-- Drawer + backdrop -->
  <aside id="drawer" class="drawer" aria-label="Navigation">
    <div class="drawer-hd">Menu</div>
    <ul id="nav" class="nav"></ul>
  </aside>
  <div id="backdrop" class="backdrop"></div>

  <!-- Content -->
  <main class="content">
    <h1>Search your operation</h1>
    <p class="subtle">Try: “planting records for North Field in 2023”, “maintenance on S780”, “Jake’s hours last week”…</p>

    <section class="card">
      <div class="searchbar">
        <input id="global-search" type="text" placeholder="Search or ask a question…" autocomplete="off">
        <button class="icon-btn" title="Voice (placeholder)">🎤</button>
      </div>
    </section>

    <section class="card">
      <h2>Recent activity</h2>
      <div class="row" id="recent"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span id="version">v0.0.0</span><span>•</span><span id="df-date-footer"></span>
  </footer>

  <!-- Data + core -->
  <script src="assets/data/menus.js"></script>
  <script src="js/core.js"></script>

  <!-- Page wiring -->
  <script>
  (function(){
    'use strict';

    /* Drawer toggle */
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const btn = document.getElementById('hamburger');
    function open(){ drawer.classList.add('open'); backdrop.classList.add('show'); }
    function close(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); }
    function toggle(){ drawer.classList.contains('open') ? close() : open(); }
    btn.addEventListener('click', toggle);
    backdrop.addEventListener('click', close);
    window.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });

    /* Build drawer from DF_MENUS */
    const nav = document.getElementById('nav');
    const menus = (window.DF_MENUS && Array.isArray(window.DF_MENUS.tiles)) ? window.DF_MENUS.tiles : [];
    nav.innerHTML='';
    menus.forEach(sec=>{
      const li=document.createElement('li');
      const b=document.createElement('button');
      b.className='section-btn'; b.setAttribute('aria-expanded','false');
      b.innerHTML=`<span class="section-ico">${sec.iconEmoji||'📁'}</span><span>${sec.label||''}</span><span class="chev">›</span>`;
      const sub=document.createElement('div'); sub.className='sub';
      (sec.children||[]).forEach(ch=>{
        const a=document.createElement('a'); a.href=ch.href||'#'; a.textContent=`${ch.iconEmoji||''} ${ch.label||''}`;
        sub.appendChild(a);
      });
      b.addEventListener('click',(e)=>{
        if (e.target.classList.contains('chev')) {
          const o=sub.classList.toggle('open'); b.setAttribute('aria-expanded', o ? 'true':'false');
        } else if (sec.href) {
          location.href = sec.href;
        }
      });
      li.appendChild(b); if ((sec.children||[]).length) li.appendChild(sub);
      nav.appendChild(li);
    });

    /* Breadcrumbs for Home */
    document.getElementById('crumbs').innerHTML = '<li><span>Home</span></li>';

    /* Time (header) + Date (footer) */
    const clockEl = document.getElementById('df-clock');
    const dateFoot = document.getElementById('df-date-footer');
    const tz = 'America/Chicago';
    function renderNow(){
      const now = new Date();
      if (clockEl) clockEl.textContent = now.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true,timeZone:tz});
      if (dateFoot) dateFoot.textContent = now.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'2-digit',year:'numeric',timeZone:tz});
    }
    renderNow(); const n=new Date(); const ms=(60-n.getSeconds())*1000-n.getMilliseconds();
    setTimeout(()=>{ renderNow(); setInterval(renderNow, 60000); }, Math.max(0, ms));

    /* Logout */
    const lg=document.getElementById('logout');
    if (lg) lg.addEventListener('click', e=>{
      e.preventDefault();
      if (window.handleLogout) return handleLogout(e);
      if (window.DF_UI?.logout) return DF_UI.logout(e);
      location.href = (document.querySelector('base')?.href || './') + 'auth/';
    });

    /* Recent activity */
    const recent=document.getElementById('recent');
    [
      {label:'Added equipment “S780”', href:'equipment/equipment-combines.html'},
      {label:'Imported planting logs (Apr 2024)', href:'crop-production/crop-planting.html'},
      {label:'Generated AI report', href:'reports/reports-ai.html'}
    ].forEach(i=>{
      const a=document.createElement('a'); a.href=i.href; a.className='btn'; a.textContent=i.label; recent.appendChild(a);
    });

    /* Register service worker */
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("serviceworker.js").catch(err=>{
        console.warn("SW failed:", err);
      });
    }
  })();
  </script>
</body>
</html>