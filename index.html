<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dowson Farms — Home</title>
  <base href="/DowsonFarms/">
  <link rel="stylesheet" href="assets/css/theme.css" />
  <style>
    body { margin:0; background:#f6f3e4; font-family: system-ui,Segoe UI,Roboto,Arial; }
    header { height:40px; background:#E6DCB8; display:flex; align-items:center; padding:0 10px; border-bottom:1px solid rgba(0,0,0,.08) }
    header .title { font-weight:700; }
    main { padding:18px; max-width:1000px; margin:0 auto; }
    h1 { color:#1B5E20; margin-top:0; }
    .tiles { display:grid; gap:14px; margin-top:20px; }
    .tile { background:#fff; border:1px solid rgba(0,0,0,.1); border-radius:12px; padding:18px; font-size:18px; font-weight:600; text-align:center; cursor:pointer; }
    .tile:hover { background:#f0f0f0; }
    footer { margin-top:40px; text-align:center; font-size:12px; color:#666; }

    /* Diagnostics */
    #diagBar { margin:0; padding:10px; font-size:13px; background:#fffbe7; border-bottom:1px solid #ccc; white-space:pre-wrap; }
    #diagBar.err { background:#ffe9e9; color:#a00; }
    #diagBar.ok { background:#eef5ee; color:#125212; }
  </style>
</head>
<body>
  <header>
    <div class="title">Dowson Farms — Home</div>
    <div style="flex:1"></div>
    <button onclick="logout()" style="padding:6px 12px;border-radius:6px;border:1px solid #ccc;background:#fff;cursor:pointer">Logout</button>
  </header>

  <!-- Diagnostic banner -->
  <div id="diagBar">Loading diagnostics...</div>

  <main>
    <h1>Welcome to Dowson Farms</h1>
    <p>Select an area to begin:</p>
    <div id="tiles" class="tiles"></div>
    <footer>Dowson Farms App © 2025</footer>
  </main>

  <script src="assets/data/menus.js"></script>
  <script type="module">
    import { loadAccess } from "./js/role-engine.js";

    const diag = document.getElementById("diagBar");
    const tilesEl = document.getElementById("tiles");

    async function render() {
      try {
        const access = await loadAccess();

        // diagnostics: dump roles + perms
        const info = [
          `Role keys: ${JSON.stringify(access.roleKeys)}`,
          `Perms loaded: ${Object.keys(access.permsByPath).length}`,
          JSON.stringify(access.permsByPath, null, 2)
        ].join("\n");

        diag.textContent = info;
        diag.className = access.roleKeys.length ? "ok" : "err";

        // render tiles based on perms
        const filtered = access.filterMenusForHome(window.DF_MENUS || []);
        tilesEl.innerHTML = "";
        if (!filtered.length) {
          tilesEl.innerHTML = `<p style="color:#a00">No visible tiles for your role. Check role permissions in Firestore.</p>`;
        } else {
          filtered.forEach(tile => {
            const div = document.createElement("div");
            div.className = "tile";
            div.textContent = `${tile.iconEmoji || ""} ${tile.label}`;
            div.onclick = () => location.href = tile.href;
            tilesEl.appendChild(div);
          });
        }
      } catch (e) {
        diag.textContent = "Error loading roles: " + e.message;
        diag.className = "err";
      }
    }

    render();
    window.logout = function() {
      localStorage.removeItem("df_user");
      location.href = "auth/";
    };
  </script>
</body>
</html>