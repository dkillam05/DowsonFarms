<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Account Roles ‚Äî Dowson Farms</title>

  <!-- Prepaint theme -->
  <script>
    (function () {
      var pref = localStorage.getItem('df_theme') || 'auto';
      var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', pref === 'auto' ? (dark ? 'dark' : 'light') : pref);
      document.documentElement.style.colorScheme =
        (pref === 'auto' ? (dark ? 'dark' : 'light') : pref) === 'dark' ? 'dark' : 'light';
    })();
  </script>

  <!-- Honor your tree exactly -->
  <link rel="stylesheet" href="../assets/css/theme.css" />
  <script defer src="../js/version.js"></script>

  <!-- IMPORTANT: firebase-init is an ES module -->
  <script type="module" src="../js/firebase-init.js"></script>

  <script defer src="../js/core.js"></script>
  <!-- Global menus (single source of truth) -->
  <script defer src="../assets/data/menus.js"></script>

  <style>
    .pill-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(118px,1fr))}
    .pill{display:inline-flex;align-items:center;justify-content:center;padding:12px 18px;border-radius:18px;border:2px solid var(--btn-secondary-border,#164d1a);background:var(--tile-bg,#fff);color:var(--btn-secondary-fg,#164d1a);font-weight:600;line-height:1;user-select:none}
    .pill[aria-pressed="true"]{background:var(--btn-primary-bg,#1b5e20);color:#fff;border-color:var(--btn-primary-bg,#1b5e20);box-shadow:0 2px 10px rgba(0,0,0,.12) inset}
    .menu-card{border:1px solid var(--tile-border);border-radius:16px;background:var(--tile-bg);margin:12px 0}
    .menu-head{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px 16px;cursor:pointer}
    .menu-body{padding:16px;border-top:1px dashed var(--tile-border)}
    .subwrap{border:2px dashed var(--tile-border);border-radius:14px;padding:12px;margin-top:14px}
    .subhead{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;padding:10px 6px}
    .subbody{padding:8px 4px 2px}
    .muted-sm{opacity:.85;font-size:.92rem}
    .toast{display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);padding:10px 14px;border-radius:10px;border:1px solid var(--tile-border);background:var(--tile-bg);box-shadow:0 6px 24px rgba(0,0,0,.12);z-index:9999}
    .btn-disabled{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="app-header">
    <div class="app-header__left">
      <img src="../assets/icons/icon-192.png" alt="Logo" class="app-logo" />
      <div class="app-header__title">Dowson Farms</div>
    </div>
    <div class="app-header__right"><span id="clock" class="clock">--:--</span></div>
  </header>

  <!-- Breadcrumbs -->
  <nav class="breadcrumbs" aria-label="Breadcrumb">
    <ol>
      <li><a href="../index.html">Home</a></li>
      <li class="sep">‚Ä∫</li>
      <li><a href="index.html">Setup / Settings</a></li>
      <li class="sep">‚Ä∫</li>
      <li><span>Account Roles</span></li>
    </ol>
  </nav>

  <main class="content" data-has-form>
    <div class="row" style="align-items:center; justify-content:space-between; gap:12px;">
      <h1 style="margin:0;">üõ°Ô∏è Account Roles</h1>
      <button type="button" class="btn-secondary" id="quickViewBtn">Quick View</button>
    </div>

    <div style="margin-top:12px;"></div>

    <form id="role-form" novalidate>
      <section class="card">
        <div class="field">
          <label for="roleName">Role</label>
          <select id="roleName" required></select>
          <small class="muted" id="roleHint" style="display:block;margin-top:4px;"></small>
        </div>
      </section>

      <section class="card" id="permCard">
        <h2 style="margin:0 0 6px;">Permissions</h2>
        <p class="muted">Toggle actions at the menu level, or open ‚ÄúManage submenus‚Äù to fine-tune individual screens.</p>
        <div id="menusContainer"></div>
        <div class="row" style="gap:10px;justify-content:center;margin-top:12px;">
          <button class="btn-primary" type="submit" id="saveBtn" disabled>Save permissions</button>
          <button class="btn-outline" type="button" id="discardBtn" disabled>Discard changes</button>
        </div>
      </section>
    </form>
  </main>

  <!-- Footer -->
  <footer class="app-footer">
    <span>Dowson Farms</span>
    <span class="dot">‚Ä¢</span>
    <span id="report-date">‚Äî</span>
    <span class="dot">‚Ä¢</span>
    <span id="version">v0.0.0</span>
  </footer>

  <!-- Quick View modal -->
  <div class="auth-modal__backdrop" id="qvBackdrop" role="dialog" aria-modal="true" aria-labelledby="qvTitle" style="display:none;">
    <div class="auth-modal" role="document" style="max-width:min(560px,92vw);">
      <h2 id="qvTitle">Role Permissions ‚Äî <span id="qvRole">‚Äî</span></h2>
      <ul id="qvList" style="list-style:disc; margin-left:1.2rem; padding-left:.4rem; max-height:min(60vh,520px); overflow:auto;"></ul>
      <div class="modal-actions">
        <button class="btn-secondary" id="qvClose">Close</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="dfToast" class="toast"><span id="dfToastText">Saved</span></div>

  <!-- Auth guard: if not logged in, bounce to /auth/login.html -->
  <script>
    (function authGuard(){
      let tries = 0;
      function check(){
        tries++;
        if (!window.DF_FB || !window.DF_FB_API) {
          if (tries < 15) return setTimeout(check, 80);
          return location.replace("../auth/login.html");
        }
        if (window.DF_FB.auth && !window.DF_FB.auth.currentUser) {
          return location.replace("../auth/login.html");
        }
        // Stay subscribed: if token expires we‚Äôll bounce
        window.DF_FB_API.onAuth(function(user){
          if (!user) location.replace("../auth/login.html");
        });
      }
      check();
    })();
  </script>

  <!-- Page logic -->
  <script type="module">
    import {
      doc, getDoc, setDoc, getDocs, collection, orderBy, query, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    /* ==============================
       1) Build MENUS from DF_MENUS
       ============================== */
    function buildMenusFromDF(df){
      const out = {};
      if (!df || !Array.isArray(df.tiles)) return out;
      df.tiles.forEach(tile => {
        const top = String(tile.label || '').trim();
        if (!top) return;
        const kids = Array.isArray(tile.children) ? tile.children : [];
        const subs = kids.map(k => String(k.label || '').trim()).filter(Boolean);
        if (subs.length) out[top] = subs;
      });
      return out;
    }
    const MENUS = buildMenusFromDF(window.DF_MENUS);

    /* ==============================
       2) UI + FS helpers
       ============================== */
    const DEFAULT_ROLES = ["Administrator","Owner","Manager","Employee","View Only"];
    const $ = s => document.querySelector(s);
    const el = {
      role: $('#roleName'),
      roleHint: $('#roleHint'),
      menus: $('#menusContainer'),
      save:  $('#saveBtn'),
      discard: $('#discardBtn'),
      toast: $('#dfToast'), toastTxt: $('#dfToastText'),
      qvBtn: $('#quickViewBtn'), qvB: $('#qvBackdrop'), qvList: $('#qvList'), qvRole: $('#qvRole'), qvClose: $('#qvClose')
    };

    const FB = {
      async ready(){
        if (window.DF_FB_API?.init) { await window.DF_FB_API.init(); }
        const user = window.DF_FB?.auth?.currentUser;
        if (!user) { location.replace("../auth/login.html"); throw new Error('No auth'); }
        return window.DF_FB.db;
      }
    };

    const deepClone = obj => JSON.parse(JSON.stringify(obj));
    const shallowEqual = (a,b) => JSON.stringify(a) === JSON.stringify(b);

    function toast(msg){
      el.toastTxt.textContent = msg || 'Saved';
      el.toast.style.display = 'block';
      clearTimeout(window.__t); window.__t = setTimeout(()=> el.toast.style.display='none', 1600);
    }

    function pill(label, pressed, onToggle){
      const b=document.createElement('button');
      b.type='button'; b.className='pill'; b.textContent=label;
      b.setAttribute('aria-pressed', pressed?'true':'false');
      b.addEventListener('click', ()=>{
        const on = b.getAttribute('aria-pressed')==='true';
        b.setAttribute('aria-pressed', on?'false':'true');
        onToggle(!on, b);
      });
      return b;
    }

    function ensureShape(perms){
      Object.keys(MENUS).forEach(menu=>{
        perms[menu] = perms[menu] || {};
        MENUS[menu].forEach(sm=>{
          perms[menu][sm] = perms[menu][sm] || {view:false, edit:false, add:false, archive:false, delete:false};
        });
      });
      return perms;
    }

    function menuSummary(perms, menu){
      const subs = Object.values(perms[menu]||{});
      if (!subs.length) return 'No access';
      const allFalse = subs.every(p=>!p.view && !p.edit && !p.add && !p.archive && !p.delete);
      if (allFalse) return 'No access';
      const allTrue  = subs.every(p=>p.view && p.edit && p.add && p.archive && p.delete);
      if (allTrue) return 'All';
      return 'Custom';
    }
    function summarizeChildren(perms, menu){
      const keys = Object.keys(perms[menu]||{});
      const on = keys.filter(k=>{
        const p = perms[menu][k]; return p.view||p.edit||p.add||p.archive||p.delete;
      }).length;
      if (!on) return 'None';
      if (on===keys.length) return 'All submenus';
      return `${on} of ${keys.length} submenus`;
    }

    async function seedRolesIfEmpty(db){
      const haveMenus = Object.keys(MENUS).length > 0;
      const snaps = await getDocs(collection(db,'roles'));
      if (!snaps.empty || !haveMenus) return;
      const base = {}; ensureShape(base);
      for (const name of DEFAULT_ROLES){
        await setDoc(doc(db,'roles',name), { label:name, permissions: base, createdAt: serverTimestamp() }, { merge:true });
      }
    }
    async function listRoles(db){
      let out=[];
      try{
        const qy = query(collection(db,'roles'), orderBy('label'));
        const snaps = await getDocs(qy);
        snaps.forEach(d=> out.push({ id:d.id, ...(d.data()||{}) }));
      }catch{
        const snaps = await getDocs(collection(db,'roles'));
        snaps.forEach(d=> out.push({ id:d.id, ...(d.data()||{}) }));
      }
      if (!out.length) out = DEFAULT_ROLES.map(label=>({id:label,label}));
      return out;
    }
    async function loadPerms(db, role){
      const snap = await getDoc(doc(db,'roles', role));
      const data = snap.exists()? (snap.data()||{}) : {};
      return ensureShape(data.permissions || {});
    }
    async function savePerms(db, role, perms){
      await setDoc(doc(db,'roles', role), { label: role, permissions: perms, updatedAt: serverTimestamp() }, { merge:true });
    }

    /* ==============================
       3) Page state + rendering
       ============================== */
    let db;
    let activePerms = null;
    let lastSavedPerms = null;

    function setDirtyState(){
      const dirty = !shallowEqual(activePerms, lastSavedPerms);
      el.save.disabled = !dirty;
      el.discard.disabled = !dirty;
    }

    function renderMenus(){
      el.menus.innerHTML = '';
      Object.keys(MENUS).forEach(menuName=>{
        const card = document.createElement('div'); card.className='menu-card';

        const head = document.createElement('div'); head.className='menu-head';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
        const caret = document.createElement('span'); caret.textContent='‚ñ∏'; caret.style.transition='transform .2s';
        const title = document.createElement('strong'); title.textContent = menuName;
        left.append(caret,title);
        const right = document.createElement('div'); right.className='muted-sm';
        head.append(left,right);

        const body = document.createElement('div'); body.className='menu-body'; body.style.display='none';

        const grid = document.createElement('div'); grid.className='pill-grid';
        ['View','Edit','Add','Archive','Delete'].forEach(name=>{
          const k = name.toLowerCase();
          const pressed = MENUS[menuName].every(sm => !!activePerms[menuName][sm][k]);
          const p = pill(name, pressed, (isOn)=>{
            MENUS[menuName].forEach(sm => activePerms[menuName][sm][k] = isOn);
            right.textContent = menuSummary(activePerms, menuName);
            body.querySelectorAll(`[data-sub="${menuName}::${k}"]`).forEach(btn=>{
              btn.setAttribute('aria-pressed', isOn ? 'true':'false');
            });
            setDirtyState();
          });
          p.setAttribute('aria-label', `${menuName}::${k}`);
          grid.appendChild(p);
        });
        body.appendChild(grid);

        const subWrap = document.createElement('div'); subWrap.className='subwrap';
        const sh = document.createElement('div'); sh.className='subhead';
        const shL = document.createElement('div'); shL.style.display='flex'; shL.style.alignItems='center'; shL.style.gap='8px';
        const subCaret = document.createElement('span'); subCaret.textContent='‚ñ∏'; subCaret.style.transition='transform .2s';
        const shT = document.createElement('strong'); shT.textContent='Manage submenus';
        shL.append(subCaret, shT);
        const shR = document.createElement('span'); shR.className='muted-sm';
        sh.append(shL, shR);
        const subBody = document.createElement('div'); subBody.className='subbody'; subBody.style.display='none';

        MENUS[menuName].forEach(sm=>{
          const section = document.createElement('section'); section.style.margin='10px 0 14px';
          const h = document.createElement('h3'); h.style.margin='0 0 8px'; h.textContent = `${menuName} ‚Ä∫ ${sm}`;
          const grid2 = document.createElement('div'); grid2.className='pill-grid';
          ['View','Edit','Add','Archive','Delete'].forEach(name=>{
            const k = name.toLowerCase();
            const btn = pill(name, !!activePerms[menuName][sm][k], (isOn)=>{
              activePerms[menuName][sm][k] = isOn;
              shR.textContent = summarizeChildren(activePerms, menuName);
              right.textContent = menuSummary(activePerms, menuName);
              const allOn  = MENUS[menuName].every(s=>activePerms[menuName][s][k]===true);
              const allOff = MENUS[menuName].every(s=>activePerms[menuName][s][k]===false);
              const parentBtn = body.querySelector(`.pill[aria-label="${menuName}::${k}"]`);
              if (parentBtn) parentBtn.setAttribute('aria-pressed', allOn ? 'true' : (allOff ? 'false' : parentBtn.getAttribute('aria-pressed')));
              setDirtyState();
            });
            btn.setAttribute('data-sub', `${menuName}::${k}`);
            grid2.appendChild(btn);
          });
          section.append(h, grid2);
          subBody.appendChild(section);
        });

        sh.addEventListener('click', ()=>{
          const open = subBody.style.display !== 'none';
          subBody.style.display = open ? 'none' : 'block';
          subCaret.style.transform = open ? 'rotate(0deg)' : 'rotate(90deg)';
        });

        subWrap.append(sh, subBody);
        body.appendChild(subWrap);

        head.addEventListener('click', ()=>{
          const open = body.style.display !== 'none';
          body.style.display = open ? 'none' : 'block';
          caret.style.transform = open ? 'rotate(0deg)' : 'rotate(90deg)';
        });

        right.textContent = menuSummary(activePerms, menuName);
        shR.textContent   = summarizeChildren(activePerms, menuName);

        card.append(head, body);
        el.menus.appendChild(card);
      });
      setDirtyState();
    }

    async function loadRole(roleName){
      el.roleHint.textContent = 'Loading‚Ä¶';
      activePerms = ensureShape(await loadPerms(db, roleName));
      lastSavedPerms = deepClone(activePerms);
      renderMenus();
      el.roleHint.textContent = '';
    }

    /* ==============================
       4) Init
       ============================== */
    (async function start(){
      try{
        db = await FB.ready();
        if (!Object.keys(MENUS).length) {
          console.error('DF_MENUS not available or empty ‚Äî check ../assets/data/menus.js path');
          el.roleHint.textContent = 'Menus not loaded';
          return;
        }

        await seedRolesIfEmpty(db);

        const roles = await listRoles(db);
        el.role.innerHTML = roles.map(r=>`<option value="${r.label||r.id}">${r.label||r.id}</option>`).join('');
        const last = localStorage.getItem('df_role_selected');
        if (last && roles.some(x=>(x.label||x.id)===last)) el.role.value = last;

        await loadRole(el.role.value);

        el.role.addEventListener('change', async ()=>{
          localStorage.setItem('df_role_selected', el.role.value);
          await loadRole(el.role.value);
        });

        document.getElementById('role-form').addEventListener('submit', async (e)=>{
          e.preventDefault();
          try{
            await savePerms(db, el.role.value, activePerms);
            lastSavedPerms = deepClone(activePerms);
            setDirtyState();
            toast('Permissions saved');
          }catch(err){
            console.error(err);
            toast(navigator.onLine ? 'Save failed' : 'Offline ‚Äî not saved');
          }
        });

        el.discard.addEventListener('click', ()=>{
          activePerms = deepClone(lastSavedPerms);
          renderMenus();
          toast('Changes discarded');
        });

        el.qvBtn.addEventListener('click', ()=>{
          document.getElementById('qvRole').textContent = el.role.value;
          el.qvList.innerHTML = '';
          Object.keys(MENUS).forEach(menu=>{
            const li = document.createElement('li');
            li.innerHTML = `<strong>${menu}</strong> ‚Äî ${menuSummary(activePerms, menu)}`;
            el.qvList.appendChild(li);
          });
          el.qvB.style.display='flex';
        });
        el.qvClose.addEventListener('click', ()=> el.qvB.style.display='none');
        el.qvB.addEventListener('click', (e)=>{ if(e.target===el.qvB) el.qvB.style.display='none'; });

        const d=document.getElementById('report-date');
        try{ d.textContent=new Intl.DateTimeFormat(undefined,{weekday:'short',month:'short',day:'2-digit',year:'numeric'}).format(new Date()); }
        catch{ d.textContent=new Date().toDateString(); }

      }catch(e){
        console.error(e);
        toast('Init failed');
      }
    })();
  </script>

  <!-- Service worker (from /settings-setup/ ‚Üí root) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("../serviceworker.js").catch(console.error);
      });
    }
  </script>
</body>
</html>