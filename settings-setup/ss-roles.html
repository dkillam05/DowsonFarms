<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#1B5E20" />
  <title>Account Roles — Dowson Farms</title>

  <!-- Ensure all relative links/scripts resolve on GitHub Pages -->
  <base href="/DowsonFarms/">

  <!-- Prepaint theme (no flash) -->
  <script>
    (function () {
      var pref = localStorage.getItem('df_theme') || 'auto';
      var dark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      var mode = pref === 'auto' ? (dark ? 'dark' : 'light') : pref;
      document.documentElement.setAttribute('data-theme', mode);
      document.documentElement.style.colorScheme = mode === 'dark' ? 'dark' : 'light';
    })();
  </script>

  <!-- Brand theme (existing) -->
  <link rel="stylesheet" href="../assets/css/theme.css" />

  <style>
    /* Page-specific helpers (kept light; main look comes from theme.css) */
    :root {
      --brand-green:#1B5E20;
      --paper:#f6f3e4;
      --ink:#222;
      --band:#E6DCB8;
    }
    body { margin:0; background:var(--paper); color:var(--ink); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    header {
      height: var(--crumb-h, 40px);
      background: var(--band);
      display: flex; align-items: center; gap: 8px;
      padding: 0 10px; border-bottom: 1px solid rgba(0,0,0,.08);
    }
    header .title { font-weight:700; color:#333; }
    header .spacer { flex:1; }
    header .logout {
      appearance: none; border:1px solid rgba(0,0,0,.2); background:#fff; color:#1B5E20; font-weight:700;
      padding: 6px 10px; border-radius: 10px; cursor: pointer;
    }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }

    .grid {
      display: grid; gap: 16px;
      grid-template-columns: minmax(280px, 1fr) minmax(340px, 2fr);
    }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

    .card {
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);
    }
    .card h2 { margin:0; padding:14px 16px; border-bottom:1px solid rgba(0,0,0,.06); color:var(--brand-green); font-size:18px; }
    .card .body { padding: 14px 16px 16px; }

    .field { margin-bottom: 12px; }
    .field label { display:block; font-size: 13px; margin-bottom: 6px; color:#444; }
    .field input[type="text"], .field textarea, .field select {
      width:100%; padding:10px 12px; border:1px solid rgba(0,0,0,.2); border-radius:12px; font-size:14px; outline: none;
      background:#fff;
    }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:center; }
    .row .col { flex:1; min-width: 160px; }
    .checks { display:grid; gap:8px; grid-template-columns: repeat(2, minmax(160px,1fr)); }
    .checks label { display:flex; align-items:center; gap:8px; }

    .btn {
      appearance:none; border:0; background:var(--brand-green); color:#fff; font-weight:700; padding:10px 14px; border-radius:12px; cursor:pointer;
    }
    .btn.secondary { background:#fff; border:1px solid rgba(0,0,0,.2); color:#333; }

    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid rgba(0,0,0,.06); font-size:14px; }
    th { color:#333; }
    tr:hover { background:#fafafa; }
    .pill {
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(0,0,0,.15); background:#fff;
      margin:2px 4px 2px 0;
    }

    .toolbar { display:flex; gap:8px; align-items:center; justify-content:flex-end; margin-top:8px; }
    .danger { background:#b00020; }
    .muted { color:#666; font-size:12px; }

    .toast {
      position: fixed; left:50%; transform: translateX(-50%);
      bottom: 18px; background:#333; color:#fff; padding:10px 14px; border-radius:12px; font-size:14px;
      box-shadow: 0 6px 18px rgba(0,0,0,.25); opacity:0; pointer-events:none; transition:opacity .18s;
    }
    .toast.show { opacity: 1; }
  </style>
</head>
<body>

  <header>
    <button onclick="history.back()" class="logout" aria-label="Back">← Back</button>
    <div class="title">Settings → Account Roles</div>
    <div class="spacer"></div>
    <button id="logoutBtn" class="logout">Logout</button>
  </header>

  <main>
    <div class="grid">
      <!-- Create / Edit Role -->
      <section class="card">
        <h2 id="formTitle">Create Role</h2>
        <div class="body">
          <form id="roleForm" novalidate>
            <div class="row">
              <div class="col field">
                <label for="roleName">Role name</label>
                <input id="roleName" type="text" placeholder="e.g., Manager, Operator, Admin" required />
              </div>
              <div class="col field">
                <label for="roleKey">Key (unique, no spaces)</label>
                <input id="roleKey" type="text" placeholder="e.g., manager, operator, admin" required />
              </div>
            </div>

            <div class="field">
              <label for="roleDesc">Description</label>
              <textarea id="roleDesc" rows="2" placeholder="What can this role do?"></textarea>
            </div>

            <div class="field">
              <label>Permissions</label>
              <div class="checks">
                <label><input type="checkbox" id="p_viewReports"> View Reports</label>
                <label><input type="checkbox" id="p_editEmployees"> Edit Employees</label>
                <label><input type="checkbox" id="p_manageFarms"> Manage Farms/Fields</label>
                <label><input type="checkbox" id="p_manageInventory"> Manage Inventory</label>
                <label><input type="checkbox" id="p_isAdmin"> Admin (all privileges)</label>
              </div>
              <div class="muted" style="margin-top:6px;">Tip: “Admin” implies full access; you can fine-tune later.</div>
            </div>

            <div class="row">
              <div class="col">
                <label><input type="checkbox" id="roleDefault"> Make this the default role for new users</label>
              </div>
            </div>

            <div class="toolbar">
              <button type="button" class="btn secondary" id="resetBtn">Reset</button>
              <button type="submit" class="btn" id="saveBtn">Save Role</button>
            </div>

            <input type="hidden" id="roleId" value="">
          </form>
        </div>
      </section>

      <!-- Roles List -->
      <section class="card">
        <h2>Existing Roles</h2>
        <div class="body">
          <table id="rolesTable" aria-label="Roles">
            <thead>
              <tr>
                <th>Name</th>
                <th>Key</th>
                <th>Flags</th>
                <th>Updated</th>
                <th style="width:160px;">Actions</th>
              </tr>
            </thead>
            <tbody id="rolesTbody">
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + Guard + Page Logic -->
  <script type="module" src="../js/firebase-init.js"></script>
  <script type="module" src="../js/auth-guard.js"></script>
  <script type="module" src="../js/roles.js"></script>
</body>
</html>